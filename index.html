<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
:root{--neon:#00e676;--neon-glow:rgba(0,230,118,0.2);--bg:#0a0a0a;--bg-secondary:#121212;--card:#1a1a1a;--card-hover:#202020;--blue:#00e5ff;--blue-glow:rgba(0,229,255,0.2);--red:#ff3d00;--orange:#ff9100;--text-primary:#f0f0f0;--text-secondary:#999;--border:#2a2a2a}*{box-sizing:border-box;margin:0;padding:0}body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text-primary);line-height:1.6;padding-bottom:80px;-webkit-font-smoothing:antialiased}.login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}.login-box{background:var(--card);padding:40px;border-radius:16px;border:2px solid var(--neon);max-width:400px;width:100%}.login-box h2{color:var(--neon);margin-bottom:30px;text-align:center}.nav{display:flex;background:var(--card);position:sticky;top:0;z-index:100;border-bottom:1px solid var(--border);backdrop-filter:blur(10px);box-shadow:0 4px 20px rgba(0,0,0,0.5);overflow-x:auto}.nav button{flex:1;padding:18px 12px;border:none;background:none;color:var(--text-secondary);cursor:pointer;font-size:10px;font-weight:700;min-width:85px;text-transform:uppercase;letter-spacing:0.5px;transition:all 0.3s ease;position:relative}.nav button:hover{background:rgba(0,230,118,0.05);color:var(--neon)}.nav button.active{color:var(--neon)}.nav button.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:var(--neon);box-shadow:0 0 10px var(--neon-glow)}.user-info{background:var(--bg-secondary);padding:10px 20px;text-align:right;font-size:12px;color:var(--text-secondary);border-bottom:1px solid var(--border)}.user-info strong{color:var(--neon)}.logout-btn{background:none;border:1px solid var(--red);color:var(--red);padding:4px 12px;border-radius:4px;cursor:pointer;margin-left:10px;font-size:10px}.container{padding:20px;max-width:800px;margin:auto}.panel{display:none;animation:fadeIn 0.3s ease}.panel.active{display:block}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}.panel-header h2{font-size:24px;font-weight:700;background:linear-gradient(135deg,var(--neon),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.sync-btn{background:linear-gradient(135deg,var(--card),var(--bg-secondary));color:var(--neon);border:1px solid var(--neon);padding:14px 24px;border-radius:12px;width:100%;font-weight:700;cursor:pointer;margin-bottom:24px;font-size:13px;letter-spacing:1px;text-transform:uppercase;transition:all 0.3s ease;box-shadow:0 0 20px var(--neon-glow)}.sync-btn:hover{background:var(--neon);color:var(--bg);box-shadow:0 0 30px var(--neon-glow);transform:translateY(-2px)}.sync-btn:disabled{opacity:0.5;cursor:not-allowed}.export-btn{background:var(--blue);border:none;padding:8px 16px;border-radius:8px;font-size:11px;font-weight:700;color:var(--bg);cursor:pointer;letter-spacing:0.5px;transition:all 0.3s ease;margin-left:8px}.export-btn:hover{box-shadow:0 0 20px var(--blue-glow);transform:translateY(-2px)}.save-btn{width:100%;padding:18px;background:linear-gradient(135deg,var(--neon),#00c853);color:var(--bg);border:none;border-radius:12px;font-weight:700;cursor:pointer;font-size:14px;letter-spacing:1px;text-transform:uppercase;transition:all 0.3s ease;box-shadow:0 4px 20px var(--neon-glow);margin-top:8px}.save-btn:hover{box-shadow:0 6px 30px var(--neon-glow);transform:translateY(-2px)}.save-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}.calc-box{background:linear-gradient(135deg,var(--card),var(--bg-secondary));padding:20px;border-radius:16px;border-left:4px solid var(--neon);margin-bottom:16px;transition:all 0.3s ease;position:relative;overflow:hidden}.calc-box:hover{background:var(--card-hover);transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,0.4)}.val{font-size:28px;font-weight:800;letter-spacing:-0.5px;margin-top:8px}.label-sm{font-size:11px;color:var(--text-secondary);text-transform:uppercase;font-weight:700;margin-bottom:8px;letter-spacing:1px;display:block}.stock-row{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:var(--card);border-radius:10px;margin-bottom:8px;font-size:13px;transition:all 0.3s ease;border:1px solid var(--border)}.stock-row:hover{background:var(--card-hover);border-color:var(--neon);transform:translateX(4px)}.stock-row span:last-child{color:var(--neon)}input,select{width:100%;padding:14px 16px;background:var(--card);border:1px solid var(--border);color:var(--text-primary);border-radius:10px;margin-bottom:16px;font-size:14px;font-family:'Inter',sans-serif;transition:all 0.3s ease}input:focus,select:focus{outline:none;border-color:var(--neon);box-shadow:0 0 0 3px var(--neon-glow);background:var(--bg-secondary)}input::placeholder{color:var(--text-secondary)}.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}.section-header{font-size:13px;font-weight:700;color:var(--neon);text-transform:uppercase;letter-spacing:1px;margin:24px 0 12px 0;padding-bottom:8px;border-bottom:2px solid var(--border)}.inventory-table{width:100%;border-collapse:collapse;margin-top:20px}.inventory-table th{background:var(--card);padding:12px;text-align:left;font-size:11px;color:var(--neon);border-bottom:2px solid var(--border)}.inventory-table td{padding:12px;border-bottom:1px solid var(--border);font-size:13px}.inventory-table tr:hover{background:var(--card-hover)}.status-badge{padding:4px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase}.status-available{background:rgba(0,230,118,0.2);color:var(--neon)}.status-sold{background:rgba(255,61,0,0.2);color:var(--red)}.status-raw{background:rgba(255,145,0,0.2);color:var(--orange)}.status-polished{background:rgba(0,230,118,0.2);color:var(--neon)}.status-processing{background:rgba(0,229,255,0.2);color:var(--blue)}.adjustment-note{font-size:11px;color:var(--orange);font-style:italic;margin-top:-12px;margin-bottom:12px}.wastage-info{background:rgba(255,61,0,0.1);padding:12px;border-radius:8px;margin-top:12px;font-size:12px;border-left:3px solid var(--red)}.copy-btn{background:var(--orange);border:none;padding:10px 20px;border-radius:8px;font-size:11px;font-weight:700;color:var(--bg);cursor:pointer;letter-spacing:0.5px;transition:all 0.3s ease;width:100%;margin-bottom:16px}.copy-btn:hover{box-shadow:0 0 20px rgba(255,145,0,0.3);transform:translateY(-2px)}.bulk-mode-toggle{margin-bottom:20px;padding:16px;background:var(--card);border-radius:12px;border:1px solid var(--border)}.toggle-label{display:flex;align-items:center;cursor:pointer;font-size:14px;font-weight:600}.toggle-label input[type="checkbox"]{margin-right:12px;width:auto;transform:scale(1.3)}.bulk-entry-box{background:rgba(0,229,255,0.1);padding:16px;border-radius:12px;border:2px solid var(--blue);margin-bottom:16px}.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:1000;padding:20px;overflow-y:auto}.modal-overlay.active{display:flex;align-items:center;justify-content:center}.modal-box{background:var(--card);border:2px solid var(--neon);border-radius:16px;padding:24px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid var(--border)}.modal-header h3{font-size:18px;color:var(--neon)}.modal-close{background:none;border:none;color:var(--text-secondary);font-size:28px;cursor:pointer;padding:0;width:30px;height:30px;line-height:1}.modal-close:hover{color:var(--red)}.modal-actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:20px}.edit-btn{background:var(--blue);border:none;padding:6px 12px;border-radius:6px;color:var(--bg);cursor:pointer;font-size:11px;font-weight:700;transition:all 0.3s ease}.edit-btn:hover{box-shadow:0 0 15px var(--blue-glow);transform:translateY(-1px)}.cancel-btn{background:transparent;border:1px solid var(--text-secondary);padding:12px;border-radius:8px;color:var(--text-secondary);cursor:pointer;font-size:13px;font-weight:700}.cancel-btn:hover{border-color:var(--red);color:var(--red)}@media (max-width:480px){.container{padding:15px}.nav button{font-size:9px;min-width:70px;padding:15px 8px}.val{font-size:24px}.grid-3{grid-template-columns:1fr}}
</style>
</head>
<body>

<div id="mainApp">
<div class="user-info"><strong id="currentUser"></strong><button class="logout-btn" onclick="doLogout()">Logout</button></div>
<div class="nav" id="mainNav"></div>
<div class="container">
<div id="setup" class="panel"><div class="calc-box" style="border-left-color:var(--blue)"><h3 style="color:var(--neon);margin-bottom:20px">üöÄ Setup</h3><label class="label-sm">Supabase URL</label><input type="text" id="supabase_url" placeholder="https://xxxxx.supabase.co"><label class="label-sm">Key</label><input type="text" id="supabase_key" placeholder="eyJ..."><button class="save-btn" onclick="testConnection()" style="background:var(--blue);margin-bottom:10px">Test</button><button class="save-btn" onclick="saveSupabaseConfig()">Save</button></div></div>

<div id="summary" class="panel"><button class="sync-btn" onclick="refreshData()">üîÑ Sync</button><div class="calc-box" style="border-left-color:var(--blue)"><div class="label-sm" style="color:var(--blue)">Factory Valuation</div><div id="fac_val" class="val">Rs. 0</div><div class="grid-2" style="margin-top:12px;font-size:12px;gap:20px"><div><span style="color:var(--text-secondary)">CBM:</span> <strong id="total_cbm" style="color:var(--neon)">0</strong></div><div><span style="color:var(--text-secondary)">SQM:</span> <strong id="total_sqm" style="color:var(--neon)">0</strong></div></div></div><div class="calc-box" style="border-left-color:var(--red)"><div class="label-sm" style="color:var(--red)">Total Wastage</div><div class="grid-2" style="font-size:13px;gap:16px"><div><div style="color:var(--text-secondary);font-size:11px">Cutting</div><div id="cutting_wastage_cbm" style="font-size:18px;font-weight:700;color:var(--red)">0 CBM</div></div><div><div style="color:var(--text-secondary);font-size:11px">Polish</div><div id="polish_wastage_sqft" style="font-size:18px;font-weight:700;color:var(--red)">0 SQFT</div></div><div><div style="color:var(--text-secondary);font-size:11px">Sales</div><div id="sales_wastage_sqft" style="font-size:18px;font-weight:700;color:var(--red)">0 SQFT</div></div><div><div style="color:var(--text-secondary);font-size:11px">Total %</div><div id="total_wastage_percent" style="font-size:18px;font-weight:700;color:var(--red)">0%</div></div></div></div><div class="calc-box" style="border-left-color:var(--orange)"><div class="label-sm" style="color:var(--orange)">Yard Summary (Active Blocks)</div><div class="grid-2" style="font-size:13px;gap:16px;margin-top:12px"><div><div style="color:var(--text-secondary);font-size:11px">Total Blocks</div><div id="yard_total_blocks" style="font-size:18px;font-weight:700;color:var(--orange)">0</div></div><div><div style="color:var(--text-secondary);font-size:11px">Ready (Untouched)</div><div id="yard_ready_blocks" style="font-size:18px;font-weight:700;color:var(--blue)">0</div></div><div><div style="color:var(--text-secondary);font-size:11px">Cutting</div><div id="yard_cutting_blocks" style="font-size:18px;font-weight:700;color:var(--orange)">0</div></div><div><div style="color:var(--text-secondary);font-size:11px">Need Polish</div><div id="yard_need_polish" style="font-size:18px;font-weight:700;color:var(--red)">0</div></div></div></div><div class="section-header">Lots</div><div id="lot_grid"></div><div class="section-header" style="margin-top:32px">Completed Blocks Summary</div><div id="completed_blocks_grid"></div></div>

<div id="inventory" class="panel"><div class="panel-header"><h2>Inventory</h2><div><button class="export-btn" onclick="exportInventoryExcel()">üìä Excel</button><button class="export-btn" onclick="exportInventoryPDF()">üìÑ PDF</button></div></div><div class="calc-box" style="border-left-color:var(--orange)"><div class="label-sm">Stock</div><div id="inv_total_sqft" class="val">0 SQFT</div><div id="inv_total_count" style="font-size:12px;color:var(--text-secondary);margin-top:4px">0 Slabs</div></div><div class="section-header">By Length</div><div id="length_classification"></div><div class="section-header">By Quality</div><div id="inventory_classification"></div><div class="section-header">All Slabs</div><div id="all_slabs_list"></div></div>

<div id="sales" class="panel"><div class="panel-header"><h2>Sales</h2><div><button class="export-btn" onclick="exportSalesExcel()">üìä Excel</button><button class="export-btn" onclick="exportSalesPDF()">üìÑ PDF</button></div></div><label class="label-sm">Slab (RAW or POLISHED)</label><select id="sale_slab_list" onchange="updateSaleFields()"></select><div class="calc-box" style="border-left-color:var(--blue);padding:12px;margin-bottom:16px"><div style="font-size:12px;color:var(--text-secondary)">Lot: <strong id="sale_lot_info" style="color:var(--neon)">-</strong></div><div style="font-size:12px;color:var(--text-secondary);margin-top:4px">Block: <strong id="sale_block_info" style="color:var(--blue)">-</strong></div><div style="font-size:12px;color:var(--text-secondary);margin-top:4px">Status: <strong id="sale_status_info" style="color:var(--orange)">-</strong></div></div><label class="label-sm">Customer</label><input type="text" id="sale_customer" placeholder="Name"><div class="section-header" style="margin-top:24px;color:var(--orange)">üìè Final Inspection Adjustments</div><div class="adjustment-note">Adjust for cracks, chips, or final trimming</div><div class="grid-2"><div><label class="label-sm">Original Length (cm)</label><input type="number" id="sale_original_length_cm" readonly style="background:var(--bg-secondary)"></div><div><label class="label-sm">Final Length (cm)</label><input type="number" id="sale_adjusted_length_cm" placeholder="After adjustments" oninput="recalculateSaleSqft()"></div></div><div class="grid-2"><div><label class="label-sm">Original Height (cm)</label><input type="number" id="sale_original_height_cm" readonly style="background:var(--bg-secondary)"></div><div><label class="label-sm">Final Height (cm)</label><input type="number" id="sale_adjusted_height_cm" placeholder="After adjustments" oninput="recalculateSaleSqft()"></div></div><div class="grid-2"><div><label class="label-sm">Original SQFT</label><input type="number" id="sale_original_sqft" readonly style="background:var(--bg-secondary)"></div><div><label class="label-sm">Final SQFT</label><input type="number" id="sale_final_sqft" readonly style="background:var(--card);border-color:var(--orange);font-weight:700"></div></div><label class="label-sm">Price/SQFT</label><input type="number" id="sale_price_sqft" placeholder="0.00" oninput="updateSaleSummary()"><div class="calc-box" style="border-left-color:var(--blue);margin-top:20px"><div class="label-sm">Summary</div><div id="sale_summary" style="font-size:14px;color:var(--text-secondary)">Fill details</div></div><button class="save-btn" onclick="recordSale()">Record Sale</button><div class="section-header">History</div><div id="sales_history"></div></div>

<div id="waste" class="panel"><div class="panel-header"><h2>Waste Sales</h2></div><div class="calc-box" style="border-left-color:var(--orange)"><div class="label-sm">Bulk/Weight Sale</div><label class="label-sm">Date</label><input type="date" id="waste_date"><label class="label-sm">Description</label><input type="text" id="waste_desc" placeholder="Monthly waste, Class 2"><div class="grid-2"><div><label class="label-sm">Weight (KG)</label><input type="number" id="waste_weight" placeholder="0" oninput="calculateWasteValue()"></div><div><label class="label-sm">Price/KG</label><input type="number" id="waste_price" placeholder="0.00" oninput="calculateWasteValue()"></div></div><label class="label-sm">Buyer</label><input type="text" id="waste_buyer" placeholder="Name"><div id="waste_total" style="font-size:20px;font-weight:700;color:var(--neon);margin:12px 0">Total: Rs. 0</div><button class="save-btn" onclick="saveWasteSale()">Record</button></div><div class="section-header">History</div><div id="waste_history"></div></div>

<div id="reports" class="panel"><div class="panel-header"><h2>P&L</h2><div><button class="export-btn" onclick="exportPLExcel()">üìä Excel</button><button class="export-btn" onclick="exportPLPDF()">üìÑ PDF</button></div></div><div class="calc-box" style="border-left-color:var(--neon)"><div class="label-sm" style="color:var(--neon)">Summary</div><div class="grid-2" style="margin-top:12px;gap:20px"><div><div style="font-size:11px;color:var(--text-secondary)">Investment</div><div id="pl_total_investment" style="font-size:20px;font-weight:700;color:var(--orange)">Rs. 0</div></div><div><div style="font-size:11px;color:var(--text-secondary)">Revenue</div><div id="pl_total_revenue" style="font-size:20px;font-weight:700;color:var(--blue)">Rs. 0</div></div><div><div style="font-size:11px;color:var(--text-secondary)">Net P/L</div><div id="pl_net_profit" style="font-size:24px;font-weight:800">Rs. 0</div></div><div><div style="font-size:11px;color:var(--text-secondary)">ROI</div><div id="pl_profit_margin" style="font-size:20px;font-weight:700">0%</div></div></div></div><div class="section-header">Lot P&L</div><div id="lot_pl_breakdown"></div></div>

<div id="mass" class="panel"><div class="panel-header"><h2>Register Lot</h2></div><label class="label-sm">Lot ID</label><input type="text" id="m_lot" placeholder="LOT-001"><label class="label-sm">Cost (Lakhs)</label><input type="number" id="m_cost" placeholder="0.00" step="0.01"><button class="save-btn" onclick="saveMass()">Register</button></div>

<div id="block" class="panel"><div class="panel-header"><h2>Add Block</h2></div><label class="label-sm">Select Lot</label><select id="b_lot_list"></select><label class="label-sm">Block ID</label><input type="text" id="b_id" placeholder="BLOCK-001"><div class="section-header" style="color:var(--blue)">üì¶ Original Dimensions (As Received)</div><label class="label-sm">Lengths (cm)</label><div class="grid-2"><input type="number" class="b_orig_l" placeholder="L1"><input type="number" class="b_orig_l" placeholder="L2"><input type="number" class="b_orig_l" placeholder="L3"><input type="number" class="b_orig_l" placeholder="L4"></div><label class="label-sm">Heights (cm)</label><div class="grid-2"><input type="number" class="b_orig_h" placeholder="H1"><input type="number" class="b_orig_h" placeholder="H2"><input type="number" class="b_orig_h" placeholder="H3"><input type="number" class="b_orig_h" placeholder="H4"></div><label class="label-sm">Widths (cm)</label><div class="grid-2"><input type="number" class="b_orig_w" placeholder="W1"><input type="number" class="b_orig_w" placeholder="W2"><input type="number" class="b_orig_w" placeholder="W3"><input type="number" class="b_orig_w" placeholder="W4"></div><button class="copy-btn" onclick="copyToUsableDimensions()">‚¨áÔ∏è Copy to "After Trimming" (If Same)</button><div class="section-header" style="color:var(--neon)">‚úÇÔ∏è Usable Dimensions (After Trimming)</div><label class="label-sm">Lengths (cm)</label><div class="grid-2"><input type="number" class="b_use_l" placeholder="L1" oninput="calculateBlockWastage()"><input type="number" class="b_use_l" placeholder="L2" oninput="calculateBlockWastage()"><input type="number" class="b_use_l" placeholder="L3" oninput="calculateBlockWastage()"><input type="number" class="b_use_l" placeholder="L4" oninput="calculateBlockWastage()"></div><label class="label-sm">Heights (cm)</label><div class="grid-2"><input type="number" class="b_use_h" placeholder="H1" oninput="calculateBlockWastage()"><input type="number" class="b_use_h" placeholder="H2" oninput="calculateBlockWastage()"><input type="number" class="b_use_h" placeholder="H3" oninput="calculateBlockWastage()"><input type="number" class="b_use_h" placeholder="H4" oninput="calculateBlockWastage()"></div><label class="label-sm">Widths (cm)</label><div class="grid-2"><input type="number" class="b_use_w" placeholder="W1" oninput="calculateBlockWastage()"><input type="number" class="b_use_w" placeholder="W2" oninput="calculateBlockWastage()"><input type="number" class="b_use_w" placeholder="W3" oninput="calculateBlockWastage()"><input type="number" class="b_use_w" placeholder="W4" oninput="calculateBlockWastage()"></div><div id="block_wastage_display" class="wastage-info" style="display:none"><strong>Cutting Wastage:</strong> <span id="block_wastage_text"></span></div><button class="save-btn" onclick="saveBlock()">Save Block</button><div class="section-header">Active Blocks</div><div id="active_blocks_list"></div></div>

<div id="slab" class="panel"><div class="panel-header"><h2>Cut Slab</h2></div><div class="bulk-mode-toggle"><label class="toggle-label"><input type="checkbox" id="bulk_mode_toggle" onchange="toggleBulkMode()"><span>üî¢ Bulk Entry Mode (Multiple Slabs)</span></label></div><div id="single_entry_mode"><label class="label-sm">Block (Last: <span id="last_block_info">None</span>)</label><select id="s_block_list" onchange="saveLastBlock()"></select><label class="label-sm">Slab Number</label><input type="text" id="s_slab_number" placeholder="SLAB-001"><label class="label-sm">Thickness</label><select id="s_thick"><option value="2cm">2 cm</option><option value="3cm">3 cm</option></select><label class="label-sm">Dimensions</label><div class="grid-2"><div><input type="number" id="s_l_cm" placeholder="Length (cm)" oninput="convertToInches('cut')"><div style="font-size:10px;color:var(--text-secondary);margin-top:-12px;margin-bottom:12px"><span id="s_l_in">0</span> inches</div></div><div><input type="number" id="s_h_cm" placeholder="Height (cm)" oninput="convertToInches('cut')"><div style="font-size:10px;color:var(--text-secondary);margin-top:-12px;margin-bottom:12px"><span id="s_h_in">0</span> inches</div></div></div><button class="save-btn" onclick="saveSlab()">Save Single Slab</button></div><div id="bulk_entry_mode" style="display:none"><div class="bulk-entry-box"><label class="label-sm">Block</label><select id="bulk_block_list"></select><label class="label-sm">Starting Slab Number</label><input type="text" id="bulk_start_number" placeholder="SLAB-001"><div style="font-size:11px;color:var(--blue);margin-top:-12px;margin-bottom:16px">Numbers will auto-increment: SLAB-001, SLAB-002, SLAB-003...</div><label class="label-sm">Quantity (How many slabs?)</label><input type="number" id="bulk_quantity" placeholder="e.g., 40" min="1" oninput="convertToInches('bulk')"><label class="label-sm">Thickness (Same for all)</label><select id="bulk_thick"><option value="2cm">2 cm</option><option value="3cm">3 cm</option></select><label class="label-sm">Dimensions (Same for all slabs)</label><div class="grid-2"><div><input type="number" id="bulk_l_cm" placeholder="Length (cm)" oninput="convertToInches('bulk')"><div style="font-size:10px;color:var(--text-secondary);margin-top:-12px;margin-bottom:12px"><span id="bulk_l_in">0</span> inches</div></div><div><input type="number" id="bulk_h_cm" placeholder="Height (cm)" oninput="convertToInches('bulk')"><div style="font-size:10px;color:var(--text-secondary);margin-top:-12px;margin-bottom:12px"><span id="bulk_h_in">0</span> inches</div></div></div><div class="calc-box" style="border-left-color:var(--blue);margin-top:16px"><div class="label-sm">Preview</div><div id="bulk_preview" style="font-size:13px;color:var(--text-secondary)">Enter details above</div></div><button class="save-btn" onclick="saveBulkSlabs()" style="background:var(--blue)">üíæ Save All Slabs</button></div></div><div class="section-header">Progress</div><div id="blocks_progress"></div></div>

<div id="polish" class="panel"><div class="panel-header"><h2>Polish</h2></div><label class="label-sm">Raw Slab</label><select id="p_slab_list" onchange="autoFillPolishDimensions()"></select><div class="calc-box" style="border-left-color:var(--orange);margin-bottom:16px"><div class="label-sm">Raw Dimensions</div><div id="raw_dimensions">Select slab</div></div><label class="label-sm">Polished Dimensions (cm)</label><div class="grid-2"><div><input type="number" id="p_l_cm" placeholder="Length" step="0.1" oninput="convertToInches('polish');calculatePolishWastage()"><div style="font-size:10px;color:var(--text-secondary);margin-top:-12px;margin-bottom:12px"><span id="p_l_in">0</span> inches</div></div><div><input type="number" id="p_h_cm" placeholder="Height" step="0.1" oninput="convertToInches('polish');calculatePolishWastage()"><div style="font-size:10px;color:var(--text-secondary);margin-top:-12px;margin-bottom:12px"><span id="p_h_in">0</span> inches</div></div></div><div id="polish_wastage_display" class="wastage-info" style="display:none"><strong>Polish Wastage:</strong> <span id="polish_wastage_text"></span></div><label class="label-sm">Quality</label><select id="p_q"></select><button class="save-btn" onclick="savePolish()">Finalize</button></div>

<div id="users" class="panel"><div class="panel-header"><h2>Users</h2></div><div class="calc-box" style="border-left-color:var(--blue)"><div class="label-sm">Add User</div><label class="label-sm">Username</label><input type="text" id="new_username" placeholder="username"><label class="label-sm">Password</label><input type="text" id="new_password" placeholder="password"><label class="label-sm">Role</label><select id="new_role"><option value="admin">Admin</option><option value="supervisor">Supervisor</option></select><button class="save-btn" onclick="addUser()">Add</button></div><div class="section-header">All Users</div><div id="users_list"></div></div>
</div></div>

<div id="edit_modal" class="modal-overlay">
<div class="modal-box">
<div class="modal-header">
<h3 id="edit_modal_title">Edit</h3>
<button class="modal-close" onclick="closeEditModal()">&times;</button>
</div>
<div id="edit_modal_content"></div>
<div class="modal-actions">
<button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
<button class="save-btn" id="save_edit_btn">Save Changes</button>
</div>
</div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let supabaseClient=null,currentUser=null,currentRole=null,globalData={lots:[],blocks:[],slabs:[],sales:[],wasteSales:[]};const SUPABASE_URL='YOUR_SUPABASE_URL_HERE',SUPABASE_KEY='YOUR_SUPABASE_KEY_HERE';const menuConfig={admin:['summary','inventory','sales','waste','reports','mass','block','slab','polish','users'],supervisor:['inventory','mass','block','slab','polish']},menuNames={summary:'Dashboard',inventory:'Inventory',sales:'Sales',waste:'Waste',reports:'P&L',mass:'Lot',block:'Block',slab:'Cut',polish:'Polish',users:'Users'};

// AUTO-LOGIN AS ADMIN - NO PASSWORD REQUIRED
currentUser='admin';
currentRole='admin';

window.addEventListener('load',initApp);

function initApp(){
  // Set user info immediately
  document.getElementById('currentUser').textContent=currentUser+' (Admin - No Login Required)';
  
  // Create navigation
  const nav=document.getElementById('mainNav');
  nav.innerHTML='';
  menuConfig[currentRole].forEach((panelId,index)=>{
    const btn=document.createElement('button');
    btn.textContent=menuNames[panelId];
    btn.onclick=()=>showPanel(panelId,btn);
    if(index===0)btn.classList.add('active');
    nav.appendChild(btn);
  });
  
  const config=JSON.parse(localStorage.getItem('supabase_config')||'{}');
  
  if(typeof window.supabase==='undefined'){
    alert('Supabase library failed. Please refresh.');
    return;
  }
  
  let url=SUPABASE_URL,key=SUPABASE_KEY;
  if(url==='YOUR_SUPABASE_URL_HERE'){
    url=config.url;
    key=config.key;
  }
  
  if(!url||!key){
    // Show setup panel
    document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
    document.getElementById('setup').style.display='block';
    return;
  }
  
  supabaseClient=window.supabase.createClient(url,key);
  
  // Show dashboard
  showPanel('summary',nav.firstChild);
  refreshData();
  loadQualityGrades();
  loadLastBlock();
  if(currentRole==='admin'){refreshUsers()}
}

function doLogout(){location.reload()}

function showMainApp(){
  showPanel('summary',document.querySelector('.nav button'));
  refreshData();
  loadQualityGrades();
  loadLastBlock();
  if(currentRole==='admin'){refreshUsers()}
}

function showPanel(id,btn){document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));document.getElementById(id).classList.add('active');if(btn)btn.classList.add('active')}

function saveSupabaseConfig(){const url=document.getElementById('supabase_url').value.trim(),key=document.getElementById('supabase_key').value.trim();if(!url||!key){alert('Enter both');return}localStorage.setItem('supabase_config',JSON.stringify({url,key}));alert('Saved! Refreshing...');setTimeout(()=>location.reload(),500)}

async function testConnection(){const url=document.getElementById('supabase_url').value.trim(),key=document.getElementById('supabase_key').value.trim();if(!url||!key){alert('Enter credentials');return}try{const testClient=window.supabase.createClient(url,key);const{error}=await testClient.from('lots').select('count');if(error&&error.code==='42P01'){alert('‚úÖ Connected! Run SQL')}else if(error){alert('‚ùå Failed: '+error.message)}else{alert('‚úÖ Connected!')}}catch(error){alert('‚ùå Failed: '+error.message)}}

async function refreshData(){if(!supabaseClient)return;const btn=document.querySelector('.sync-btn');if(btn){btn.innerText="‚è≥ Syncing...";btn.disabled=true}try{const{data:lots}=await supabaseClient.from('lots').select('*');const{data:blocks}=await supabaseClient.from('blocks').select('*');const{data:slabs}=await supabaseClient.from('slabs').select('*');const{data:sales}=await supabaseClient.from('sales').select('*');const{data:wasteSales}=await supabaseClient.from('waste_sales').select('*');globalData={lots:lots||[],blocks:blocks||[],slabs:slabs||[],sales:sales||[],wasteSales:wasteSales||[]};

const blockToLotMap={};(blocks||[]).forEach(block=>{const key=`${block.lot_id}-${block.block_id}`;blockToLotMap[key]=block.lot_id});

const availableSlabs=[];let factoryVal=0,factorySqft=0,totalCuttingWastage=0,totalPolishWastage=0,totalSalesWastage=0,wastageSalesRevenue=0;

(blocks||[]).forEach(block=>{totalCuttingWastage+=parseFloat(block.cutting_wastage_cbm||0)});

(slabs||[]).forEach(slab=>{const lotId=blockToLotMap[slab.block_id];if(slab.status==='POLISHED'){totalPolishWastage+=parseFloat(slab.polish_wastage_sqft||0);const isSold=(sales||[]).some(s=>s.slab_id===slab.id);if(!isSold){availableSlabs.push({...slab,lotId});factoryVal+=parseFloat(slab.value||0);factorySqft+=parseFloat(slab.polished_sqft||0)}}else if(slab.status==='RAW'){const isSold=(sales||[]).some(s=>s.slab_id===slab.id);if(!isSold){availableSlabs.push({...slab,lotId});factorySqft+=parseFloat(slab.raw_sqft||0)}}});

(sales||[]).forEach(sale=>{totalSalesWastage+=parseFloat(sale.sales_wastage_sqft||0);if(sale.slab_status==='WASTAGE'){wastageSalesRevenue+=parseFloat(sale.total_value||0)}});

const totalFactoryValue=factoryVal+wastageSalesRevenue;document.getElementById('fac_val').innerText="Rs. "+totalFactoryValue.toLocaleString('en-IN');const totalCBM=(lots||[]).reduce((sum,lot)=>sum+parseFloat(lot.total_cbm||0),0);document.getElementById('total_cbm').innerText=totalCBM.toFixed(2)+" m¬≥";document.getElementById('total_sqm').innerText=(factorySqft/10.764).toFixed(2)+" m¬≤";document.getElementById('cutting_wastage_cbm').innerText=totalCuttingWastage.toFixed(2)+" CBM";document.getElementById('polish_wastage_sqft').innerText=totalPolishWastage.toFixed(0)+" SQFT";document.getElementById('sales_wastage_sqft').innerText=totalSalesWastage.toFixed(0)+" SQFT";

const totalWastagePercent=factorySqft>0?((totalPolishWastage+totalSalesWastage)/factorySqft*100).toFixed(1):0;document.getElementById('total_wastage_percent').innerText=totalWastagePercent+"%";

const activeBlocks=(blocks||[]).filter(b=>b.status==='ACTIVE');const readyBlocks=activeBlocks.filter(b=>!b.processing_status||b.processing_status==='READY');const cuttingBlocks=activeBlocks.filter(b=>b.processing_status==='PROCESSING');let needPolishCount=0;activeBlocks.forEach(block=>{const blockKey=`${block.lot_id}-${block.block_id}`;const blockRawSlabs=(slabs||[]).filter(s=>s.block_id===blockKey&&s.status==='RAW'&&!(sales||[]).some(sale=>sale.slab_id===s.id));if(blockRawSlabs.length>0)needPolishCount++});document.getElementById('yard_total_blocks').innerText=activeBlocks.length;document.getElementById('yard_ready_blocks').innerText=readyBlocks.length;document.getElementById('yard_cutting_blocks').innerText=cuttingBlocks.length;document.getElementById('yard_need_polish').innerText=needPolishCount;

let lotHtml="";(lots||[]).forEach(lot=>{const lotBlocks=(blocks||[]).filter(b=>b.lot_id===lot.lot_id);const lotSales=(sales||[]).filter(s=>s.lot_id===lot.lot_id);const revenue=lotSales.reduce((sum,s)=>sum+parseFloat(s.total_value),0);const investment=parseFloat(lot.cost)*100000;const pl=revenue-investment;const plColor=pl>=0?'var(--neon)':'var(--red)';const isActive=lot.status==='ACTIVE';const statusBadge=isActive?'<span class="status-badge status-available">ACTIVE</span>':'<span class="status-badge status-sold">DONE</span>';const cuttingWaste=lotBlocks.reduce((sum,b)=>sum+parseFloat(b.cutting_wastage_cbm||0),0);lotHtml+=`<div class="calc-box" style="border-left-color:${plColor}"><div style="display:flex;justify-content:space-between"><div style="flex:1"><div class="label-sm" style="color:${plColor}">${lot.lot_id} ${statusBadge}</div><div style="font-size:18px;font-weight:700;color:${plColor};margin:8px 0">${pl>=0?'+':''}Rs. ${pl.toLocaleString('en-IN')}</div><div style="font-size:11px;color:var(--text-secondary)">CBM: ${(lot.total_cbm||0).toFixed(2)} | Price/CBM: Rs. ${(lot.price_per_cbm||0).toFixed(0)} | Cut Waste: ${cuttingWaste.toFixed(2)} CBM</div></div><div style="display:flex;flex-direction:column;gap:8px;margin-left:10px"><button class="edit-btn" onclick="editLot('${lot.lot_id}')">‚úèÔ∏è Edit</button>${isActive?`<button onclick="completeLot('${lot.lot_id}')" style="background:var(--neon);border:none;padding:8px 16px;border-radius:8px;color:#000;cursor:pointer;font-size:11px;font-weight:700">Complete</button>`:''}</div></div></div>`});document.getElementById('lot_grid').innerHTML=lotHtml||'<div style="text-align:center;padding:40px;color:var(--text-secondary)">No lots</div>';

let completedBlocksHtml='';const completedBlocks=(blocks||[]).filter(b=>b.status==='COMPLETED');if(completedBlocks.length>0){completedBlocks.forEach(block=>{const blockKey=`${block.lot_id}-${block.block_id}`;const blockSlabs=(slabs||[]).filter(s=>s.block_id===blockKey);let rawCBM=0,polishedCBM=0,soldCBM=0,rawCount=0,polishedCount=0,soldCount=0;blockSlabs.forEach(slab=>{const thickness=slab.thickness==='2cm'?2:3;const isSold=(sales||[]).some(s=>s.slab_id===slab.id);if(isSold){const sale=(sales||[]).find(s=>s.slab_id===slab.id);const finalL=parseFloat(sale.final_length_cm||sale.length_cm||0);const finalH=parseFloat(sale.final_height_cm||sale.height_cm||0);soldCBM+=(finalL*finalH*thickness)/1000000;soldCount++}else if(slab.status==='RAW'){const lcm=parseFloat(slab.raw_length_cm||0);const hcm=parseFloat(slab.raw_height_cm||0);rawCBM+=(lcm*hcm*thickness)/1000000;rawCount++}else if(slab.status==='POLISHED'){const lcm=parseFloat(slab.polished_length_cm||0);const hcm=parseFloat(slab.polished_height_cm||0);polishedCBM+=(lcm*hcm*thickness)/1000000;polishedCount++}});const origCBM=parseFloat(block.original_volume||0);const useCBM=parseFloat(block.usable_volume||0);const wasteCBM=parseFloat(block.cutting_wastage_cbm||0);const totalSlabsCBM=rawCBM+polishedCBM+soldCBM;const totalCount=rawCount+polishedCount+soldCount;const utilizationPercent=useCBM>0?((totalSlabsCBM/useCBM)*100).toFixed(1):0;const overallYield=origCBM>0?((totalSlabsCBM/origCBM)*100).toFixed(1):0;const cardColor=overallYield>=35?'var(--neon)':overallYield>=25?'var(--orange)':'var(--red)';completedBlocksHtml+=`<div class="calc-box" style="border-left-color:${cardColor}"><div class="label-sm" style="color:${cardColor}">${blockKey} <span class="status-badge" style="background:rgba(0,230,118,0.2);color:var(--neon);margin-left:8px">COMPLETED</span></div><div style="margin-top:12px"><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px"><div style="text-align:center;padding:8px;background:rgba(0,229,255,0.1);border-radius:8px"><div style="font-size:10px;color:var(--text-secondary);text-transform:uppercase">Original</div><div style="font-size:16px;font-weight:700;color:var(--blue);margin-top:4px">${origCBM.toFixed(2)}</div><div style="font-size:9px;color:var(--text-secondary)">CBM</div></div><div style="text-align:center;padding:8px;background:rgba(0,230,118,0.1);border-radius:8px"><div style="font-size:10px;color:var(--text-secondary);text-transform:uppercase">Usable</div><div style="font-size:16px;font-weight:700;color:var(--neon);margin-top:4px">${useCBM.toFixed(2)}</div><div style="font-size:9px;color:var(--text-secondary)">CBM</div></div><div style="text-align:center;padding:8px;background:rgba(255,61,0,0.1);border-radius:8px"><div style="font-size:10px;color:var(--text-secondary);text-transform:uppercase">Cut Waste</div><div style="font-size:16px;font-weight:700;color:var(--red);margin-top:4px">${wasteCBM.toFixed(2)}</div><div style="font-size:9px;color:var(--text-secondary)">${(origCBM>0?((wasteCBM/origCBM)*100):0).toFixed(1)}%</div></div><div style="text-align:center;padding:8px;background:rgba(255,145,0,0.1);border-radius:8px"><div style="font-size:10px;color:var(--text-secondary);text-transform:uppercase">Total Slabs</div><div style="font-size:16px;font-weight:700;color:var(--orange);margin-top:4px">${totalSlabsCBM.toFixed(3)}</div><div style="font-size:9px;color:var(--text-secondary)">${totalCount} pcs</div></div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:11px;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px"><div style="text-align:center"><div style="color:var(--text-secondary)">RAW</div><div style="color:var(--orange);font-weight:700;margin-top:4px">${rawCount} slabs</div><div style="font-size:10px;color:var(--text-secondary)">${rawCBM.toFixed(3)} CBM</div></div><div style="text-align:center"><div style="color:var(--text-secondary)">POLISHED</div><div style="color:var(--neon);font-weight:700;margin-top:4px">${polishedCount} slabs</div><div style="font-size:10px;color:var(--text-secondary)">${polishedCBM.toFixed(3)} CBM</div></div><div style="text-align:center"><div style="color:var(--text-secondary)">SOLD</div><div style="color:var(--blue);font-weight:700;margin-top:4px">${soldCount} slabs</div><div style="font-size:10px;color:var(--text-secondary)">${soldCBM.toFixed(3)} CBM</div></div></div><div style="display:flex;justify-content:space-between;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)"><div style="font-size:12px"><span style="color:var(--text-secondary)">Utilization:</span> <strong style="color:${utilizationPercent>=40?'var(--neon)':'var(--orange)'}">${utilizationPercent}%</strong> <span style="color:var(--text-secondary);font-size:10px">(of usable)</span></div><div style="font-size:12px"><span style="color:var(--text-secondary)">Overall Yield:</span> <strong style="color:${cardColor}">${overallYield}%</strong> <span style="color:var(--text-secondary);font-size:10px">(of original)</span></div></div></div></div>`})}else{completedBlocksHtml='<div style="text-align:center;padding:40px;color:var(--text-secondary)">No completed blocks yet</div>'}document.getElementById('completed_blocks_grid').innerHTML=completedBlocksHtml;

document.getElementById('inv_total_sqft').innerText=factorySqft.toFixed(0)+" SQFT";document.getElementById('inv_total_count').innerText=availableSlabs.length+" Slabs";

const inventoryByLength={'150+':0,'200+':0,'220+':0,'240+':0,'250+':0,'280+':0,'300+':0};const inventoryByQuality={};availableSlabs.forEach(slab=>{const lengthCm=parseFloat(slab.polished_length_cm||slab.raw_length_cm||0);if(lengthCm>=300)inventoryByLength['300+']++;else if(lengthCm>=280)inventoryByLength['280+']++;else if(lengthCm>=250)inventoryByLength['250+']++;else if(lengthCm>=240)inventoryByLength['240+']++;else if(lengthCm>=220)inventoryByLength['220+']++;else if(lengthCm>=200)inventoryByLength['200+']++;else if(lengthCm>=150)inventoryByLength['150+']++;if(slab.status==='POLISHED'){const quality=getQualityName(slab.rate,slab.thickness);if(!inventoryByQuality[quality])inventoryByQuality[quality]={count:0,sqft:0};inventoryByQuality[quality].count++;inventoryByQuality[quality].sqft+=parseFloat(slab.polished_sqft||0)}});

let lengthHtml="";['300+','280+','250+','240+','220+','200+','150+'].forEach(range=>{if(inventoryByLength[range]>0)lengthHtml+=`<div class="stock-row"><span>${range} cm</span><span style="font-weight:700">${inventoryByLength[range]} slabs</span></div>`});document.getElementById('length_classification').innerHTML=lengthHtml||'<div style="text-align:center;padding:40px;color:var(--text-secondary)">No inventory</div>';

let invHtml="";for(let quality in inventoryByQuality){const data=inventoryByQuality[quality];invHtml+=`<div class="stock-row"><span>${quality} (${data.count} slabs)</span><span style="font-weight:700">${data.sqft.toFixed(0)} sqft</span></div>`}document.getElementById('inventory_classification').innerHTML=invHtml||'<div style="text-align:center;padding:40px;color:var(--text-secondary)">No inventory</div>';

let allSlabsHtml='<table class="inventory-table"><tr><th>Slab</th><th>Lot</th><th>Block</th><th>Status</th><th>Dims (cm)</th><th>SQFT</th><th>Quality</th><th>Edit</th></tr>';(slabs||[]).forEach(slab=>{const isSold=(sales||[]).some(s=>s.slab_id===slab.id);const quality=slab.status==='POLISHED'&&slab.rate?getQualityName(slab.rate,slab.thickness):'Raw';const lotId=blockToLotMap[slab.block_id]||'-';const dims=slab.status==='POLISHED'?`${slab.polished_length_cm||'-'} √ó ${slab.polished_height_cm||'-'}`:`${slab.raw_length_cm||'-'} √ó ${slab.raw_height_cm||'-'}`;const sqft=slab.status==='POLISHED'?slab.polished_sqft:slab.raw_sqft;allSlabsHtml+=`<tr><td>${slab.slab_number||slab.id}</td><td>${lotId}</td><td>${slab.block_id}</td><td><span class="status-badge ${isSold?'status-sold':slab.status==='POLISHED'?'status-polished':'status-raw'}">${isSold?'SOLD':slab.status}</span></td><td>${dims}</td><td>${sqft}</td><td>${quality}</td><td>${!isSold?`<button class="edit-btn" onclick="editSlab(${slab.id})">‚úèÔ∏è</button>`:'-'}</td></tr>`});allSlabsHtml+='</table>';document.getElementById('all_slabs_list').innerHTML=allSlabsHtml;

document.getElementById('b_lot_list').innerHTML=(lots||[]).filter(l=>l.status==='ACTIVE').map(l=>`<option value="${l.lot_id}">${l.lot_id}</option>`).join('')||'<option>No lots</option>';

document.getElementById('s_block_list').innerHTML=(blocks||[]).filter(b=>b.status==='ACTIVE'||b.processing_status==='PROCESSING').map(b=>`<option value="${b.lot_id}-${b.block_id}">${b.lot_id}-${b.block_id}</option>`).join('')||'<option>No blocks</option>';

let activeBlocksHtml='';const activeBlocks=(blocks||[]).filter(b=>b.status==='ACTIVE');if(activeBlocks.length>0){activeBlocksHtml='<table class="inventory-table"><tr><th>Block</th><th>Lot</th><th>Status</th><th>Original CBM</th><th>Usable CBM</th><th>Cut Waste</th><th>Slabs CBM</th><th>Actions</th></tr>';activeBlocks.forEach(block=>{const statusBadge=block.processing_status==='PROCESSING'?'<span class="status-badge status-processing">CUTTING</span>':'<span class="status-badge status-available">READY</span>';const blockKey=`${block.lot_id}-${block.block_id}`;const blockSlabs=(slabs||[]).filter(s=>s.block_id===blockKey);let slabsCBM=0;blockSlabs.forEach(slab=>{const thickness=slab.thickness==='2cm'?2:3;if(slab.status==='RAW'){const lcm=parseFloat(slab.raw_length_cm||0);const hcm=parseFloat(slab.raw_height_cm||0);slabsCBM+=(lcm*hcm*thickness)/1000000}else if(slab.status==='POLISHED'){const lcm=parseFloat(slab.polished_length_cm||0);const hcm=parseFloat(slab.polished_height_cm||0);slabsCBM+=(lcm*hcm*thickness)/1000000}});const origCBM=parseFloat(block.original_volume||0);const useCBM=parseFloat(block.usable_volume||0);const wasteCBM=parseFloat(block.cutting_wastage_cbm||0);const wastePercent=origCBM>0?((wasteCBM/origCBM)*100).toFixed(1):0;const slabsCount=blockSlabs.length;const slabsInfo=slabsCount>0?`${slabsCBM.toFixed(3)} (${slabsCount})`:'0';activeBlocksHtml+=`<tr><td>${block.block_id}</td><td>${block.lot_id}</td><td>${statusBadge}</td><td style="color:var(--blue);font-weight:600">${origCBM.toFixed(2)}</td><td style="color:var(--neon);font-weight:600">${useCBM.toFixed(2)}</td><td style="color:var(--red);font-weight:600">${wasteCBM.toFixed(2)} (${wastePercent}%)</td><td style="color:var(--orange);font-weight:600">${slabsInfo}</td><td><button class="edit-btn" onclick="editBlock('${block.lot_id}','${block.block_id}')">‚úèÔ∏è</button> <button onclick="completeBlock('${block.lot_id}','${block.block_id}')" style="background:var(--neon);border:none;padding:6px 12px;border-radius:4px;color:#000;cursor:pointer;font-size:11px;font-weight:700">Complete</button></td></tr>`});activeBlocksHtml+='</table>'}else{activeBlocksHtml='<div style="text-align:center;padding:40px;color:var(--text-secondary)">No blocks</div>'}document.getElementById('active_blocks_list').innerHTML=activeBlocksHtml;

let progressHtml='';activeBlocks.forEach(block=>{const blockKey=`${block.lot_id}-${block.block_id}`;const blockSlabs=(slabs||[]).filter(s=>s.block_id===blockKey);const slabCount=blockSlabs.length;let rawCBM=0,polishedCBM=0,rawCount=0,polishedCount=0;blockSlabs.forEach(slab=>{const thickness=slab.thickness==='2cm'?2:3;if(slab.status==='RAW'){const lcm=parseFloat(slab.raw_length_cm||0);const hcm=parseFloat(slab.raw_height_cm||0);rawCBM+=(lcm*hcm*thickness)/1000000;rawCount++}else if(slab.status==='POLISHED'){const lcm=parseFloat(slab.polished_length_cm||0);const hcm=parseFloat(slab.polished_height_cm||0);polishedCBM+=(lcm*hcm*thickness)/1000000;polishedCount++}});const origCBM=parseFloat(block.original_volume||0);const useCBM=parseFloat(block.usable_volume||0);const totalSlabsCBM=rawCBM+polishedCBM;const utilizationPercent=useCBM>0?((totalSlabsCBM/useCBM)*100).toFixed(1):0;progressHtml+=`<div class="calc-box" style="border-left-color:var(--blue)"><div style="display:flex;justify-content:space-between;margin-bottom:12px"><div style="flex:1"><div class="label-sm">${blockKey}</div><div style="font-size:16px;font-weight:700;color:var(--neon)">${slabCount} slabs cut</div></div><button onclick="completeBlock('${block.lot_id}','${block.block_id}')" style="background:var(--neon);border:none;padding:8px 16px;border-radius:8px;color:#000;cursor:pointer;font-size:11px;font-weight:700">Complete</button></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;font-size:11px"><div><div style="color:var(--text-secondary)">Original</div><div style="color:var(--blue);font-weight:700">${origCBM.toFixed(2)} CBM</div></div><div><div style="color:var(--text-secondary)">Usable</div><div style="color:var(--neon);font-weight:700">${useCBM.toFixed(2)} CBM</div></div><div><div style="color:var(--text-secondary)">Slabs Cut</div><div style="color:var(--orange);font-weight:700">${totalSlabsCBM.toFixed(3)} CBM</div></div></div><div style="margin-top:8px;font-size:11px"><span style="color:var(--text-secondary)">Status:</span> <strong style="color:var(--orange)">${rawCount} RAW</strong> | <strong style="color:var(--neon)">${polishedCount} POLISHED</strong> | <span style="color:var(--text-secondary)">Utilization:</span> <strong style="color:var(--blue)">${utilizationPercent}%</strong></div></div>`});document.getElementById('blocks_progress').innerHTML=progressHtml||'<div style="text-align:center;padding:40px;color:var(--text-secondary)">No blocks</div>';

const rawSlabs=(slabs||[]).filter(s=>s.status==='RAW'&&!(sales||[]).some(sale=>sale.slab_id===s.id));document.getElementById('p_slab_list').innerHTML=rawSlabs.map(s=>`<option value="${s.id}">${s.slab_number||s.id} | ${s.block_id}</option>`).join('')||'<option>No slabs</option>';

document.getElementById('sale_slab_list').innerHTML='<option value="">Select...</option>'+availableSlabs.map(s=>{const quality=s.status==='POLISHED'?getQualityName(s.rate,s.thickness):'RAW';const sqft=s.status==='POLISHED'?s.polished_sqft:s.raw_sqft;const statusLabel=s.status==='RAW'?'[RAW]':'[POLISHED]';return`<option value="${s.id}" data-lot="${s.lotId}" data-block="${s.block_id}" data-status="${s.status}" data-sqft="${sqft}" data-lcm="${s.status==='POLISHED'?s.polished_length_cm:s.raw_length_cm}" data-hcm="${s.status==='POLISHED'?s.polished_height_cm:s.raw_height_cm}" data-thick="${s.thickness}">${s.slab_number||s.id} ${statusLabel} | ${s.lotId} | ${quality} | ${sqft} sqft</option>`}).join('');

if(sales&&sales.length>0){let salesHtml='<table class="inventory-table"><tr><th>Slab</th><th>Status</th><th>Lot</th><th>Customer</th><th>SQFT</th><th>Value</th></tr>';sales.forEach(sale=>{const statusBadge=sale.slab_status==='RAW'?'<span class="status-badge status-raw">RAW</span>':'<span class="status-badge status-polished">POLISHED</span>';salesHtml+=`<tr><td>${sale.slab_number}</td><td>${statusBadge}</td><td>${sale.lot_id||'-'}</td><td>${sale.customer_name}</td><td>${sale.final_sqft||sale.sold_sqft}</td><td style="color:var(--neon)">Rs. ${parseFloat(sale.total_value).toLocaleString('en-IN')}</td></tr>`});salesHtml+='</table>';document.getElementById('sales_history').innerHTML=salesHtml}else{document.getElementById('sales_history').innerHTML='<div style="text-align:center;padding:40px;color:var(--text-secondary)">No sales</div>'}

if(wasteSales&&wasteSales.length>0){let wasteHtml='<table class="inventory-table"><tr><th>Date</th><th>Description</th><th>Weight (KG)</th><th>Price/KG</th><th>Value</th></tr>';wasteSales.forEach(ws=>{wasteHtml+=`<tr><td>${new Date(ws.sale_date).toLocaleDateString()}</td><td>${ws.description||'-'}</td><td>${ws.weight_kg}</td><td>Rs. ${ws.price_per_kg}</td><td style="color:var(--neon)">Rs. ${parseFloat(ws.total_value).toLocaleString('en-IN')}</td></tr>`});wasteHtml+='</table>';document.getElementById('waste_history').innerHTML=wasteHtml}else{document.getElementById('waste_history').innerHTML='<div style="text-align:center;padding:40px;color:var(--text-secondary)">No waste sales</div>'}

updatePLReport(lots,sales,wasteSales)}catch(error){console.error('Error:',error);alert('Error: '+error.message)}finally{if(btn){btn.innerText="üîÑ Sync";btn.disabled=false}}}

function getQualityName(rate,thickness){const grades=JSON.parse(localStorage.getItem('quality_grades')||JSON.stringify([{name:'Premium 2cm',rate:150,thickness:'2cm'},{name:'Premium 3cm',rate:200,thickness:'3cm'},{name:'Standard 2cm',rate:100,thickness:'2cm'},{name:'Standard 3cm',rate:130,thickness:'3cm'},{name:'Commercial',rate:75,thickness:'2cm'}]));const match=grades.find(g=>g.rate==rate&&g.thickness===thickness);return match?match.name:`Quality ${rate}`}

function updatePLReport(lots,sales,wasteSales){let totalInvestment=0,totalRevenue=0;(lots||[]).forEach(lot=>{totalInvestment+=parseFloat(lot.cost)*100000});(sales||[]).forEach(sale=>{totalRevenue+=parseFloat(sale.total_value)});(wasteSales||[]).forEach(ws=>{totalRevenue+=parseFloat(ws.total_value)});const netProfit=totalRevenue-totalInvestment;const roi=totalInvestment>0?((netProfit/totalInvestment)*100).toFixed(2):0;const profitColor=netProfit>=0?'var(--neon)':'var(--red)';document.getElementById('pl_total_investment').innerText='Rs. '+totalInvestment.toLocaleString('en-IN');document.getElementById('pl_total_revenue').innerText='Rs. '+totalRevenue.toLocaleString('en-IN');document.getElementById('pl_net_profit').innerText=(netProfit>=0?'+ ':'- ')+'Rs. '+Math.abs(netProfit).toLocaleString('en-IN');document.getElementById('pl_net_profit').style.color=profitColor;document.getElementById('pl_profit_margin').innerText=roi+'%';document.getElementById('pl_profit_margin').style.color=profitColor;let lotBreakdownHtml='<table class="inventory-table"><tr><th>Lot</th><th>Investment</th><th>Revenue</th><th>P/L</th><th>ROI</th></tr>';(lots||[]).forEach(lot=>{const investment=parseFloat(lot.cost)*100000;const revenue=(sales||[]).filter(s=>s.lot_id===lot.lot_id).reduce((sum,s)=>sum+parseFloat(s.total_value),0);const profit=revenue-investment;const lotROI=investment>0?((profit/investment)*100).toFixed(1):0;const pColor=profit>=0?'var(--neon)':'var(--red)';lotBreakdownHtml+=`<tr><td>${lot.lot_id}</td><td>Rs. ${investment.toLocaleString('en-IN')}</td><td style="color:var(--blue)">Rs. ${revenue.toLocaleString('en-IN')}</td><td style="color:${pColor};font-weight:700">${profit>=0?'+':''}Rs. ${profit.toLocaleString('en-IN')}</td><td style="color:${pColor}">${lotROI}%</td></tr>`});lotBreakdownHtml+='</table>';document.getElementById('lot_pl_breakdown').innerHTML=lotBreakdownHtml}

function exportInventoryExcel(){const wb=XLSX.utils.book_new();const blockToLotMap={};globalData.blocks.forEach(block=>{blockToLotMap[`${block.lot_id}-${block.block_id}`]=block.lot_id});const availableSlabs=globalData.slabs.filter(slab=>!globalData.sales.some(s=>s.slab_id===slab.id));const rawSlabs=availableSlabs.filter(s=>s.status==='RAW');const polishedSlabs=availableSlabs.filter(s=>s.status==='POLISHED');const summaryData=[['INVENTORY SUMMARY REPORT'],['Generated: '+new Date().toLocaleString()],[''],['üìä OVERALL SUMMARY'],['Total Available Slabs',availableSlabs.length],['RAW (Unpolished)',rawSlabs.length],['POLISHED (Ready to Sell)',polishedSlabs.length],[''],['Total Available SQFT',availableSlabs.reduce((sum,s)=>{const sqft=s.status==='POLISHED'?parseFloat(s.polished_sqft||0):parseFloat(s.raw_sqft||0);return sum+sqft},0).toFixed(0)],['RAW SQFT',rawSlabs.reduce((sum,s)=>sum+parseFloat(s.raw_sqft||0),0).toFixed(0)],['POLISHED SQFT',polishedSlabs.reduce((sum,s)=>sum+parseFloat(s.polished_sqft||0),0).toFixed(0)],[''],['üî¢ RAW SLABS BY LENGTH'],['Length Range','Count','SQFT']];const rawByLength={'300+':0,'280+':0,'250+':0,'240+':0,'220+':0,'200+':0,'150+':0};const rawSqftByLength={'300+':0,'280+':0,'250+':0,'240+':0,'220+':0,'200+':0,'150+':0};rawSlabs.forEach(slab=>{const lengthCm=parseFloat(slab.raw_length_cm||0);const sqft=parseFloat(slab.raw_sqft||0);if(lengthCm>=300){rawByLength['300+']++;rawSqftByLength['300+']+=sqft}else if(lengthCm>=280){rawByLength['280+']++;rawSqftByLength['280+']+=sqft}else if(lengthCm>=250){rawByLength['250+']++;rawSqftByLength['250+']+=sqft}else if(lengthCm>=240){rawByLength['240+']++;rawSqftByLength['240+']+=sqft}else if(lengthCm>=220){rawByLength['220+']++;rawSqftByLength['220+']+=sqft}else if(lengthCm>=200){rawByLength['200+']++;rawSqftByLength['200+']+=sqft}else if(lengthCm>=150){rawByLength['150+']++;rawSqftByLength['150+']+=sqft}});['300+','280+','250+','240+','220+','200+','150+'].forEach(range=>{if(rawByLength[range]>0)summaryData.push([range+' cm',rawByLength[range],rawSqftByLength[range].toFixed(0)])});summaryData.push([''],['‚ú® POLISHED SLABS BY LENGTH'],['Length Range','Count','SQFT']);const polishedByLength={'300+':0,'280+':0,'250+':0,'240+':0,'220+':0,'200+':0,'150+':0};const polishedSqftByLength={'300+':0,'280+':0,'250+':0,'240+':0,'220+':0,'200+':0,'150+':0};polishedSlabs.forEach(slab=>{const lengthCm=parseFloat(slab.polished_length_cm||0);const sqft=parseFloat(slab.polished_sqft||0);if(lengthCm>=300){polishedByLength['300+']++;polishedSqftByLength['300+']+=sqft}else if(lengthCm>=280){polishedByLength['280+']++;polishedSqftByLength['280+']+=sqft}else if(lengthCm>=250){polishedByLength['250+']++;polishedSqftByLength['250+']+=sqft}else if(lengthCm>=240){polishedByLength['240+']++;polishedSqftByLength['240+']+=sqft}else if(lengthCm>=220){polishedByLength['220+']++;polishedSqftByLength['220+']+=sqft}else if(lengthCm>=200){polishedByLength['200+']++;polishedSqftByLength['200+']+=sqft}else if(lengthCm>=150){polishedByLength['150+']++;polishedSqftByLength['150+']+=sqft}});['300+','280+','250+','240+','220+','200+','150+'].forEach(range=>{if(polishedByLength[range]>0)summaryData.push([range+' cm',polishedByLength[range],polishedSqftByLength[range].toFixed(0)])});summaryData.push([''],['üé® POLISHED BY QUALITY'],['Quality','Count','SQFT']);const byQuality={};polishedSlabs.forEach(slab=>{const quality=getQualityName(slab.rate,slab.thickness);if(!byQuality[quality])byQuality[quality]={count:0,sqft:0};byQuality[quality].count++;byQuality[quality].sqft+=parseFloat(slab.polished_sqft||0)});Object.keys(byQuality).forEach(quality=>{summaryData.push([quality,byQuality[quality].count,byQuality[quality].sqft.toFixed(0)])});const wsSummary=XLSX.utils.aoa_to_sheet(summaryData);XLSX.utils.book_append_sheet(wb,wsSummary,'Summary');const detailData=[['Slab','Lot','Block','Status','Length (cm)','Height (cm)','SQFT','Thickness','Quality']];availableSlabs.forEach(slab=>{const quality=slab.status==='POLISHED'&&slab.rate?getQualityName(slab.rate,slab.thickness):'Raw';const lotId=blockToLotMap[slab.block_id]||'-';const lengthCm=slab.status==='POLISHED'?slab.polished_length_cm:slab.raw_length_cm;const heightCm=slab.status==='POLISHED'?slab.polished_height_cm:slab.raw_height_cm;const sqft=slab.status==='POLISHED'?slab.polished_sqft:slab.raw_sqft;detailData.push([slab.slab_number||slab.id,lotId,slab.block_id,slab.status,lengthCm||'-',heightCm||'-',sqft,slab.thickness,quality])});const wsDetail=XLSX.utils.aoa_to_sheet(detailData);XLSX.utils.book_append_sheet(wb,wsDetail,'Detailed Inventory');XLSX.writeFile(wb,'Inventory_Report.xlsx')}

function exportInventoryPDF(){const{jsPDF}=window.jspdf;const doc=new jsPDF();let yPos=15;doc.setFontSize(20);doc.setFont(undefined,'bold');doc.text('INVENTORY REPORT',14,yPos);yPos+=8;doc.setFontSize(10);doc.setFont(undefined,'normal');doc.text('Generated: '+new Date().toLocaleString(),14,yPos);yPos+=10;const blockToLotMap={};globalData.blocks.forEach(block=>{blockToLotMap[`${block.lot_id}-${block.block_id}`]=block.lot_id});const availableSlabs=globalData.slabs.filter(slab=>!globalData.sales.some(s=>s.slab_id===slab.id));const rawSlabs=availableSlabs.filter(s=>s.status==='RAW');const polishedSlabs=availableSlabs.filter(s=>s.status==='POLISHED');const totalRawSqft=rawSlabs.reduce((sum,s)=>sum+parseFloat(s.raw_sqft||0),0);const totalPolishedSqft=polishedSlabs.reduce((sum,s)=>sum+parseFloat(s.polished_sqft||0),0);doc.setFontSize(14);doc.setFont(undefined,'bold');doc.text('SUMMARY',14,yPos);yPos+=7;doc.autoTable({startY:yPos,head:[['Category','Count','SQFT']],body:[['Available Slabs',availableSlabs.length,(totalRawSqft+totalPolishedSqft).toFixed(0)],['RAW (Unpolished)',rawSlabs.length,totalRawSqft.toFixed(0)],['POLISHED (Ready)',polishedSlabs.length,totalPolishedSqft.toFixed(0)]],theme:'grid',headStyles:{fillColor:[0,230,118],textColor:[10,10,10],fontStyle:'bold'},styles:{fontSize:10},margin:{left:14}});yPos=doc.lastAutoTable.finalY+10;doc.setFontSize(12);doc.setFont(undefined,'bold');doc.text('RAW SLABS BY LENGTH',14,yPos);yPos+=5;const rawByLength={'300+':0,'280+':0,'250+':0,'240+':0,'220+':0,'200+':0,'150+':0};const rawSqftByLength={'300+':0,'280+':0,'250+':0,'240+':0,'220+':0,'200+':0,'150+':0};rawSlabs.forEach(slab=>{const lengthCm=parseFloat(slab.raw_length_cm||0);const sqft=parseFloat(slab.raw_sqft||0);if(lengthCm>=300){rawByLength['300+']++;rawSqftByLength['300+']+=sqft}else if(lengthCm>=280){rawByLength['280+']++;rawSqftByLength['280+']+=sqft}else if(lengthCm>=250){rawByLength['250+']++;rawSqftByLength['250+']+=sqft}else if(lengthCm>=240){rawByLength['240+']++;rawSqftByLength['240+']+=sqft}else if(lengthCm>=220){rawByLength['220+']++;rawSqftByLength['220+']+=sqft}else if(lengthCm>=200){rawByLength['200+']++;rawSqftByLength['200+']+=sqft}else if(lengthCm>=150){rawByLength['150+']++;rawSqftByLength['150+']+=sqft}});const rawLengthData=['300+','280+','250+','240+','220+','200+','150+'].filter(range=>rawByLength[range]>0).map(range=>[range+' cm',rawByLength[range],rawSqftByLength[range].toFixed(0)]);if(rawLengthData.length>0){doc.autoTable({startY:yPos,head:[['Length','Count','SQFT']],body:rawLengthData,theme:'striped',headStyles:{fillColor:[255,145,0],textColor:[10,10,10],fontStyle:'bold'},styles:{fontSize:9},margin:{left:14}});yPos=doc.lastAutoTable.finalY+10}else{doc.setFontSize(9);doc.text('No RAW slabs available',14,yPos);yPos+=10}if(yPos>250){doc.addPage();yPos=15}doc.setFontSize(12);doc.setFont(undefined,'bold');doc.text('POLISHED SLABS BY LENGTH',14,yPos);yPos+=5;const polishedByLength={'300+':0,'280+':0,'250+':0,'240+':0,'220+':0,'200+':0,'150+':0};const polishedSqftByLength={'300+':0,'280+':0,'250+':0,'240+':0,'220+':0,'200+':0,'150+':0};polishedSlabs.forEach(slab=>{const lengthCm=parseFloat(slab.polished_length_cm||0);const sqft=parseFloat(slab.polished_sqft||0);if(lengthCm>=300){polishedByLength['300+']++;polishedSqftByLength['300+']+=sqft}else if(lengthCm>=280){polishedByLength['280+']++;polishedSqftByLength['280+']+=sqft}else if(lengthCm>=250){polishedByLength['250+']++;polishedSqftByLength['250+']+=sqft}else if(lengthCm>=240){polishedByLength['240+']++;polishedSqftByLength['240+']+=sqft}else if(lengthCm>=220){polishedByLength['220+']++;polishedSqftByLength['220+']+=sqft}else if(lengthCm>=200){polishedByLength['200+']++;polishedSqftByLength['200+']+=sqft}else if(lengthCm>=150){polishedByLength['150+']++;polishedSqftByLength['150+']+=sqft}});const polishedLengthData=['300+','280+','250+','240+','220+','200+','150+'].filter(range=>polishedByLength[range]>0).map(range=>[range+' cm',polishedByLength[range],polishedSqftByLength[range].toFixed(0)]);if(polishedLengthData.length>0){doc.autoTable({startY:yPos,head:[['Length','Count','SQFT']],body:polishedLengthData,theme:'striped',headStyles:{fillColor:[0,230,118],textColor:[10,10,10],fontStyle:'bold'},styles:{fontSize:9},margin:{left:14}});yPos=doc.lastAutoTable.finalY+10}else{doc.setFontSize(9);doc.text('No POLISHED slabs available',14,yPos);yPos+=10}if(yPos>250){doc.addPage();yPos=15}doc.setFontSize(12);doc.setFont(undefined,'bold');doc.text('POLISHED BY QUALITY',14,yPos);yPos+=5;const byQuality={};polishedSlabs.forEach(slab=>{const quality=getQualityName(slab.rate,slab.thickness);if(!byQuality[quality])byQuality[quality]={count:0,sqft:0};byQuality[quality].count++;byQuality[quality].sqft+=parseFloat(slab.polished_sqft||0)});const qualityData=Object.keys(byQuality).map(quality=>[quality,byQuality[quality].count,byQuality[quality].sqft.toFixed(0)]);if(qualityData.length>0){doc.autoTable({startY:yPos,head:[['Quality','Count','SQFT']],body:qualityData,theme:'striped',headStyles:{fillColor:[0,229,255],textColor:[10,10,10],fontStyle:'bold'},styles:{fontSize:9},margin:{left:14}});yPos=doc.lastAutoTable.finalY+10}if(yPos>250||qualityData.length===0){doc.addPage();yPos=15}doc.setFontSize(14);doc.setFont(undefined,'bold');doc.text('DETAILED INVENTORY',14,yPos);yPos+=7;const tableData=availableSlabs.map(slab=>{const quality=slab.status==='POLISHED'&&slab.rate?getQualityName(slab.rate,slab.thickness):'Raw';const slabNumber=slab.slab_number||slab.id;const dims=slab.status==='POLISHED'?`${slab.polished_length_cm||'-'} x ${slab.polished_height_cm||'-'}`:`${slab.raw_length_cm||'-'} x ${slab.raw_height_cm||'-'}`;const sqft=slab.status==='POLISHED'?slab.polished_sqft:slab.raw_sqft;return[slabNumber,slab.status,dims,sqft,quality]});doc.autoTable({startY:yPos,head:[['Slab ID','Status','Dims (cm)','SQFT','Quality']],body:tableData,theme:'grid',headStyles:{fillColor:[26,26,26],textColor:[0,230,118],fontStyle:'bold'},styles:{fontSize:7},margin:{left:14}});doc.save('Inventory_Report.pdf')}

function exportSalesExcel(){const wb=XLSX.utils.book_new();const wsData=[['Slab','Status','Lot','Customer','Final (cm)','SQFT','Price/SQFT','Total Value','Date']];globalData.sales.forEach(sale=>{const finalDims=`${sale.final_length_cm||sale.length_cm} √ó ${sale.final_height_cm||sale.height_cm}`;wsData.push([sale.slab_number,sale.slab_status,sale.lot_id||'-',sale.customer_name,finalDims,sale.final_sqft||sale.sold_sqft,sale.price_per_sqft,sale.total_value,new Date(sale.created_at).toLocaleDateString()])});const ws=XLSX.utils.aoa_to_sheet(wsData);XLSX.utils.book_append_sheet(wb,ws,'Sales');XLSX.writeFile(wb,'Sales_Export.xlsx')}

function exportSalesPDF(){const{jsPDF}=window.jspdf;const doc=new jsPDF();doc.setFontSize(18);doc.text('Sales Report',14,15);const tableData=globalData.sales.map(sale=>[sale.slab_number,sale.slab_status,sale.lot_id||'-',sale.customer_name,sale.final_sqft||sale.sold_sqft,`Rs. ${parseFloat(sale.total_value).toLocaleString('en-IN')}`]);doc.autoTable({head:[['Slab','Status','Lot','Customer','SQFT','Value']],body:tableData,startY:25,styles:{fontSize:8}});doc.save('Sales_Report.pdf')}

function exportPLExcel(){const wb=XLSX.utils.book_new();const wsData=[['Lot','Investment (Rs)','Revenue (Rs)','Profit/Loss (Rs)','ROI (%)']];globalData.lots.forEach(lot=>{const investment=parseFloat(lot.cost)*100000;const revenue=globalData.sales.filter(s=>s.lot_id===lot.lot_id).reduce((sum,s)=>sum+parseFloat(s.total_value),0);const profit=revenue-investment;const roi=investment>0?((profit/investment)*100).toFixed(1):0;wsData.push([lot.lot_id,investment,revenue,profit,roi])});const ws=XLSX.utils.aoa_to_sheet(wsData);XLSX.utils.book_append_sheet(wb,ws,'P&L');XLSX.writeFile(wb,'PL_Report.xlsx')}

function exportPLPDF(){const{jsPDF}=window.jspdf;const doc=new jsPDF();doc.setFontSize(18);doc.text('P&L Report',14,15);const tableData=globalData.lots.map(lot=>{const investment=parseFloat(lot.cost)*100000;const revenue=globalData.sales.filter(s=>s.lot_id===lot.lot_id).reduce((sum,s)=>sum+parseFloat(s.total_value),0);const profit=revenue-investment;const roi=investment>0?((profit/investment)*100).toFixed(1):0;return[lot.lot_id,`Rs. ${investment.toLocaleString('en-IN')}`,`Rs. ${revenue.toLocaleString('en-IN')}`,`Rs. ${profit.toLocaleString('en-IN')}`,`${roi}%`]});doc.autoTable({head:[['Lot','Investment','Revenue','P/L','ROI']],body:tableData,startY:25,styles:{fontSize:9}});doc.save('PL_Report.pdf')}

function calculateBlockWastage(){const getMin=(cls)=>{const v=Array.from(document.getElementsByClassName(cls)).map(i=>parseFloat(i.value)).filter(v=>v>0);return v.length?Math.min(...v):0};const origL=getMin('b_orig_l'),origH=getMin('b_orig_h'),origW=getMin('b_orig_w');const useL=getMin('b_use_l'),useH=getMin('b_use_h'),useW=getMin('b_use_w');if(origL&&origH&&origW&&useL&&useH&&useW){const origVol=(origL*origH*origW)/1000000;const useVol=(useL*useH*useW)/1000000;const wastage=origVol-useVol;const wastagePercent=((wastage/origVol)*100).toFixed(1);document.getElementById('block_wastage_display').style.display='block';document.getElementById('block_wastage_text').innerHTML=`${wastage.toFixed(3)} CBM (${wastagePercent}%)<br><small>Original: ${origVol.toFixed(3)} CBM ‚Üí Usable: ${useVol.toFixed(3)} CBM</small>`}else{document.getElementById('block_wastage_display').style.display='none'}}

function calculatePolishWastage(){const rawSqft=parseFloat(document.getElementById('p_slab_list').selectedOptions[0]?.getAttribute('data-sqft')||0);const polishLcm=parseFloat(document.getElementById('p_l_cm').value)||0;const polishHcm=parseFloat(document.getElementById('p_h_cm').value)||0;if(rawSqft&&polishLcm&&polishHcm){const polishLin=polishLcm/2.54;const polishHin=polishHcm/2.54;const polishSqft=(polishLin*polishHin)/144;const wastage=rawSqft-polishSqft;const wastagePercent=((wastage/rawSqft)*100).toFixed(1);document.getElementById('polish_wastage_display').style.display='block';document.getElementById('polish_wastage_text').innerHTML=`${wastage.toFixed(2)} sqft (${wastagePercent}%)<br><small>Raw: ${rawSqft.toFixed(2)} sqft ‚Üí Polished: ${polishSqft.toFixed(2)} sqft</small>`}else{document.getElementById('polish_wastage_display').style.display='none'}}

function convertToInches(mode){if(mode==='bulk'){const lcm=parseFloat(document.getElementById('bulk_l_cm').value)||0;const hcm=parseFloat(document.getElementById('bulk_h_cm').value)||0;const qty=parseInt(document.getElementById('bulk_quantity').value)||0;document.getElementById('bulk_l_in').innerText=(lcm/2.54).toFixed(2);document.getElementById('bulk_h_in').innerText=(hcm/2.54).toFixed(2);if(qty>0&&lcm>0&&hcm>0){const lin=lcm/2.54;const hin=hcm/2.54;const sqft=(lin*hin)/144;const startNum=document.getElementById('bulk_start_number').value||'SLAB-001';document.getElementById('bulk_preview').innerHTML=`<div style="font-size:14px"><strong style="color:var(--neon)">${qty} slabs</strong> will be created<br><span style="color:var(--text-secondary)">Starting from:</span> <strong>${startNum}</strong><br><span style="color:var(--text-secondary)">Each slab:</span> ${lcm} √ó ${hcm} cm = <strong style="color:var(--blue)">${sqft.toFixed(2)} sqft</strong><br><span style="color:var(--text-secondary)">Total:</span> <strong style="color:var(--neon)">${(sqft*qty).toFixed(2)} sqft</strong></div>`}}else if(mode==='cut'){const lcm=parseFloat(document.getElementById('s_l_cm').value)||0;const hcm=parseFloat(document.getElementById('s_h_cm').value)||0;document.getElementById('s_l_in').innerText=(lcm/2.54).toFixed(2);document.getElementById('s_h_in').innerText=(hcm/2.54).toFixed(2)}else{const lcm=parseFloat(document.getElementById('p_l_cm').value)||0;const hcm=parseFloat(document.getElementById('p_h_cm').value)||0;document.getElementById('p_l_in').innerText=(lcm/2.54).toFixed(2);document.getElementById('p_h_in').innerText=(hcm/2.54).toFixed(2)}}

function saveLastBlock(){const block=document.getElementById('s_block_list').value;localStorage.setItem('last_block',block);document.getElementById('last_block_info').innerText=block}

function loadLastBlock(){const lastBlock=localStorage.getItem('last_block');if(lastBlock){const select=document.getElementById('s_block_list');if(select){select.value=lastBlock;document.getElementById('last_block_info').innerText=lastBlock}}}

async function saveMass(){if(!supabaseClient)return;const lot=document.getElementById('m_lot').value.trim();const cost=parseFloat(document.getElementById('m_cost').value);if(!lot||!cost){alert('Fill all');return}try{const{error}=await supabaseClient.from('lots').insert([{lot_id:lot,cost:cost,status:'ACTIVE'}]);if(error)throw error;document.getElementById('m_lot').value='';document.getElementById('m_cost').value='';await refreshData();alert('Lot registered!')}catch(error){alert('Error: '+error.message)}}

async function saveBlock(){if(!supabaseClient)return;const getMin=(cls)=>{const v=Array.from(document.getElementsByClassName(cls)).map(i=>parseFloat(i.value)).filter(v=>v>0);return v.length?Math.min(...v):0};const origL=getMin('b_orig_l'),origH=getMin('b_orig_h'),origW=getMin('b_orig_w');const useL=getMin('b_use_l'),useH=getMin('b_use_h'),useW=getMin('b_use_w');const lotId=document.getElementById('b_lot_list').value;const blockId=document.getElementById('b_id').value.trim();if(!origL||!origH||!origW||!useL||!useH||!useW||!blockId){alert('Fill all dimensions');return}const origVol=(origL*origH*origW)/1000000;const useVol=(useL*useH*useW)/1000000;try{const{error}=await supabaseClient.from('blocks').insert([{lot_id:lotId,block_id:blockId,original_length:origL,original_width:origW,original_height:origH,original_volume:origVol.toFixed(3),usable_length:useL,usable_width:useW,usable_height:useH,usable_volume:useVol.toFixed(3),status:'ACTIVE',processing_status:'READY'}]);if(error)throw error;document.getElementById('b_id').value='';document.querySelectorAll('.b_orig_l, .b_orig_h, .b_orig_w, .b_use_l, .b_use_h, .b_use_w').forEach(i=>i.value='');document.getElementById('block_wastage_display').style.display='none';await refreshData();alert('Block saved!')}catch(error){alert('Error: '+error.message)}}

async function saveSlab(){if(!supabaseClient)return;const lcm=parseFloat(document.getElementById('s_l_cm').value);const hcm=parseFloat(document.getElementById('s_h_cm').value);const blockId=document.getElementById('s_block_list').value;const thickness=document.getElementById('s_thick').value;const slabNumber=document.getElementById('s_slab_number').value.trim();if(!lcm||!hcm||!slabNumber){alert('Fill all');return}const lin=lcm/2.54;const hin=hcm/2.54;const sq=(lin*hin)/144;try{const[lotId,blockIdOnly]=blockId.split('-');await supabaseClient.from('blocks').update({processing_status:'PROCESSING'}).eq('lot_id',lotId).eq('block_id',blockIdOnly);const{error}=await supabaseClient.from('slabs').insert([{block_id:blockId,slab_number:slabNumber,status:'RAW',raw_length:lin.toFixed(2),raw_height:hin.toFixed(2),raw_length_cm:lcm,raw_height_cm:hcm,raw_sqft:sq.toFixed(2),thickness:thickness}]);if(error)throw error;document.getElementById('s_l_cm').value='';document.getElementById('s_h_cm').value='';document.getElementById('s_slab_number').value='';document.getElementById('s_l_in').innerText='0';document.getElementById('s_h_in').innerText='0';await refreshData();alert('Slab cut saved!')}catch(error){alert('Error: '+error.message)}}

async function autoFillPolishDimensions(){const slabId=document.getElementById('p_slab_list').value;if(!slabId||!supabaseClient)return;try{const{data:slab}=await supabaseClient.from('slabs').select('*').eq('id',slabId).single();if(slab){document.getElementById('p_l_cm').value=slab.raw_length_cm||'';document.getElementById('p_h_cm').value=slab.raw_height_cm||'';document.getElementById('p_slab_list').selectedOptions[0].setAttribute('data-sqft',slab.raw_sqft);convertToInches('polish');calculatePolishWastage();document.getElementById('raw_dimensions').innerHTML=`Raw: <strong>${slab.raw_length_cm} √ó ${slab.raw_height_cm} cm</strong> = ${slab.raw_sqft} sqft<br><span style="color:var(--orange);font-size:12px">Adjust polished dimensions</span>`}}catch(error){console.error('Error:',error)}}

async function savePolish(){if(!supabaseClient)return;const lcm=parseFloat(document.getElementById('p_l_cm').value);const hcm=parseFloat(document.getElementById('p_h_cm').value);const rate=parseFloat(document.getElementById('p_q').value);const rawSlabId=document.getElementById('p_slab_list').value;if(!lcm||!hcm||!rawSlabId){alert('Fill all');return}const lin=lcm/2.54;const hin=hcm/2.54;const sq=(lin*hin)/144;const value=sq*rate;try{const{data:rawSlab}=await supabaseClient.from('slabs').select('*').eq('id',rawSlabId).single();const{error}=await supabaseClient.from('slabs').update({status:'POLISHED',polished_length:lin.toFixed(2),polished_height:hin.toFixed(2),polished_length_cm:lcm,polished_height_cm:hcm,polished_sqft:sq.toFixed(2),rate:rate,value:value.toFixed(0)}).eq('id',rawSlabId);if(error)throw error;document.getElementById('p_l_cm').value='';document.getElementById('p_h_cm').value='';document.getElementById('p_l_in').innerText='0';document.getElementById('p_h_in').innerText='0';document.getElementById('polish_wastage_display').style.display='none';await refreshData();alert('Slab polished!')}catch(error){alert('Error: '+error.message)}}

function updateSaleFields(){const select=document.getElementById('sale_slab_list');const selected=select.options[select.selectedIndex];const lotId=selected.getAttribute('data-lot')||'-';const blockId=selected.getAttribute('data-block')||'-';const status=selected.getAttribute('data-status')||'-';const originalSqft=selected.getAttribute('data-sqft')||'';const lengthCm=selected.getAttribute('data-lcm')||'';const heightCm=selected.getAttribute('data-hcm')||'';document.getElementById('sale_lot_info').innerText=lotId;document.getElementById('sale_block_info').innerText=blockId;document.getElementById('sale_status_info').innerText=status;document.getElementById('sale_original_sqft').value=originalSqft;document.getElementById('sale_original_length_cm').value=lengthCm;document.getElementById('sale_original_height_cm').value=heightCm;document.getElementById('sale_adjusted_length_cm').value=lengthCm;document.getElementById('sale_adjusted_height_cm').value=heightCm;recalculateSaleSqft()}

function recalculateSaleSqft(){const lengthCm=parseFloat(document.getElementById('sale_adjusted_length_cm').value)||0;const heightCm=parseFloat(document.getElementById('sale_adjusted_height_cm').value)||0;if(lengthCm>0&&heightCm>0){const lengthIn=lengthCm/2.54;const heightIn=heightCm/2.54;const sqft=(lengthIn*heightIn)/144;document.getElementById('sale_final_sqft').value=sqft.toFixed(2)}else{document.getElementById('sale_final_sqft').value=''}updateSaleSummary()}

function updateSaleSummary(){const original=parseFloat(document.getElementById('sale_original_sqft').value)||0;const finalSqft=parseFloat(document.getElementById('sale_final_sqft').value)||0;const price=parseFloat(document.getElementById('sale_price_sqft').value)||0;if(original&&finalSqft&&price){const shrinkage=original-finalSqft;const totalValue=finalSqft*price;const shrinkPercent=(shrinkage/original*100).toFixed(1);document.getElementById('sale_summary').innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:13px"><div><div style="color:var(--text-secondary)">Wastage</div><div style="color:var(--red);font-weight:700">${shrinkage.toFixed(2)} sqft (${shrinkPercent}%)</div></div><div><div style="color:var(--text-secondary)">Total</div><div style="color:var(--neon);font-weight:700">Rs. ${totalValue.toLocaleString('en-IN')}</div></div></div>`}}

async function recordSale(){if(!supabaseClient)return;const slabId=document.getElementById('sale_slab_list').value;const customer=document.getElementById('sale_customer').value.trim();const originalSqft=parseFloat(document.getElementById('sale_original_sqft').value);const finalSqft=parseFloat(document.getElementById('sale_final_sqft').value);const priceSqft=parseFloat(document.getElementById('sale_price_sqft').value);const originalLengthCm=parseFloat(document.getElementById('sale_original_length_cm').value);const originalHeightCm=parseFloat(document.getElementById('sale_original_height_cm').value);const finalLengthCm=parseFloat(document.getElementById('sale_adjusted_length_cm').value);const finalHeightCm=parseFloat(document.getElementById('sale_adjusted_height_cm').value);const select=document.getElementById('sale_slab_list');const selected=select.options[select.selectedIndex];const lotId=selected.getAttribute('data-lot');const blockId=selected.getAttribute('data-block');const slabStatus=selected.getAttribute('data-status');if(!slabId||!customer||!finalSqft||!priceSqft){alert('Fill all');return}const shrinkage=originalSqft-finalSqft;const totalValue=finalSqft*priceSqft;try{const{data:slab}=await supabaseClient.from('slabs').select('slab_number').eq('id',slabId).single();const{error}=await supabaseClient.from('sales').insert([{slab_id:parseInt(slabId),lot_id:lotId,block_id:blockId,slab_number:slab.slab_number,slab_status:slabStatus,customer_name:customer,original_sqft:originalSqft,sold_sqft:finalSqft,final_sqft:finalSqft,price_per_sqft:priceSqft,total_value:totalValue,sales_wastage_sqft:shrinkage,length_cm:originalLengthCm,height_cm:originalHeightCm,final_length_cm:finalLengthCm,final_height_cm:finalHeightCm}]);if(error)throw error;document.getElementById('sale_slab_list').selectedIndex=0;document.getElementById('sale_customer').value='';document.getElementById('sale_lot_info').innerText='-';document.getElementById('sale_block_info').innerText='-';document.getElementById('sale_status_info').innerText='-';document.getElementById('sale_original_sqft').value='';document.getElementById('sale_original_length_cm').value='';document.getElementById('sale_original_height_cm').value='';document.getElementById('sale_adjusted_length_cm').value='';document.getElementById('sale_adjusted_height_cm').value='';document.getElementById('sale_final_sqft').value='';document.getElementById('sale_price_sqft').value='';document.getElementById('sale_summary').innerHTML='Fill details';await refreshData();alert('Sale recorded!')}catch(error){alert('Error: '+error.message)}}

function calculateWasteValue(){const weight=parseFloat(document.getElementById('waste_weight').value)||0;const price=parseFloat(document.getElementById('waste_price').value)||0;const total=weight*price;document.getElementById('waste_total').innerText='Total: Rs. '+total.toLocaleString('en-IN')}

async function saveWasteSale(){if(!supabaseClient)return;const date=document.getElementById('waste_date').value;const desc=document.getElementById('waste_desc').value.trim();const weight=parseFloat(document.getElementById('waste_weight').value);const price=parseFloat(document.getElementById('waste_price').value);const buyer=document.getElementById('waste_buyer').value.trim();if(!date||!weight||!price){alert('Fill required fields');return}const total=weight*price;try{const{error}=await supabaseClient.from('waste_sales').insert([{sale_date:date,description:desc,weight_kg:weight,price_per_kg:price,total_value:total,buyer_name:buyer}]);if(error)throw error;document.getElementById('waste_date').value='';document.getElementById('waste_desc').value='';document.getElementById('waste_weight').value='';document.getElementById('waste_price').value='';document.getElementById('waste_buyer').value='';document.getElementById('waste_total').innerText='Total: Rs. 0';await refreshData();alert('Waste sale recorded!')}catch(error){alert('Error: '+error.message)}}

async function completeBlock(lotId,blockId){if(!supabaseClient)return;if(!confirm(`Complete block "${lotId}-${blockId}"?`))return;try{await supabaseClient.from('blocks').update({status:'COMPLETED'}).eq('lot_id',lotId).eq('block_id',blockId);const{data:lotBlocks}=await supabaseClient.from('blocks').select('status').eq('lot_id',lotId);const allCompleted=lotBlocks.every(b=>b.status==='COMPLETED');if(allCompleted){await supabaseClient.from('lots').update({status:'COMPLETED'}).eq('lot_id',lotId);alert(`Block complete! Lot "${lotId}" also completed.`)}else{alert('Block completed!')}await refreshData()}catch(error){alert('Error: '+error.message)}}

async function completeLot(lotId){if(!supabaseClient)return;if(!confirm(`Complete lot "${lotId}"?`))return;try{await supabaseClient.from('lots').update({status:'COMPLETED'}).eq('lot_id',lotId);alert('Lot completed!');await refreshData()}catch(error){alert('Error: '+error.message)}}

function loadQualityGrades(){const grades=JSON.parse(localStorage.getItem('quality_grades')||JSON.stringify([{name:'Premium 2cm',rate:150,thickness:'2cm'},{name:'Premium 3cm',rate:200,thickness:'3cm'},{name:'Standard 2cm',rate:100,thickness:'2cm'},{name:'Standard 3cm',rate:130,thickness:'3cm'},{name:'Commercial',rate:75,thickness:'2cm'}]));const select=document.getElementById('p_q');if(select){select.innerHTML=grades.map(g=>`<option value="${g.rate}" data-thickness="${g.thickness}">${g.name} (Rs. ${g.rate}/sqft)</option>`).join('')}}

async function refreshUsers(){if(!supabaseClient)return;try{const{data:users}=await supabaseClient.from('users').select('*');let usersHtml='<table class="inventory-table"><tr><th>Username</th><th>Role</th><th>Action</th></tr>';(users||[]).forEach(user=>{usersHtml+=`<tr><td>${user.username}</td><td>${user.role}</td><td><button onclick="changePassword('${user.username}')" style="background:var(--blue);border:none;padding:6px 12px;border-radius:4px;color:#000;cursor:pointer;font-size:11px;font-weight:700">Change PW</button></td></tr>`});usersHtml+='</table>';document.getElementById('users_list').innerHTML=usersHtml}catch(error){alert('Error: '+error.message)}}

async function addUser(){if(!supabaseClient)return;const username=document.getElementById('new_username').value.trim();const password=document.getElementById('new_password').value.trim();const role=document.getElementById('new_role').value;if(!username||!password){alert('Fill all');return}try{const{error}=await supabaseClient.from('users').insert([{username,password,role}]);if(error)throw error;document.getElementById('new_username').value='';document.getElementById('new_password').value='';alert('User added!');refreshUsers()}catch(error){alert('Error: '+error.message)}}

async function changePassword(username){const newPass=prompt(`New password for ${username}:`);if(!newPass)return;try{await supabaseClient.from('users').update({password:newPass}).eq('username',username);alert(`Password updated for ${username}!`)}catch(error){alert('Error: '+error.message)}}

function copyToUsableDimensions(){const origLengths=Array.from(document.getElementsByClassName('b_orig_l'));const origHeights=Array.from(document.getElementsByClassName('b_orig_h'));const origWidths=Array.from(document.getElementsByClassName('b_orig_w'));const useLengths=Array.from(document.getElementsByClassName('b_use_l'));const useHeights=Array.from(document.getElementsByClassName('b_use_h'));const useWidths=Array.from(document.getElementsByClassName('b_use_w'));origLengths.forEach((input,index)=>{if(input.value)useLengths[index].value=input.value});origHeights.forEach((input,index)=>{if(input.value)useHeights[index].value=input.value});origWidths.forEach((input,index)=>{if(input.value)useWidths[index].value=input.value});calculateBlockWastage();alert('‚úÖ Copied to "After Trimming" fields!')}

function toggleBulkMode(){const isChecked=document.getElementById('bulk_mode_toggle').checked;const singleMode=document.getElementById('single_entry_mode');const bulkMode=document.getElementById('bulk_entry_mode');if(isChecked){singleMode.style.display='none';bulkMode.style.display='block';const singleBlockList=document.getElementById('s_block_list');const bulkBlockList=document.getElementById('bulk_block_list');bulkBlockList.innerHTML=singleBlockList.innerHTML}else{singleMode.style.display='block';bulkMode.style.display='none'}}

async function saveBulkSlabs(){if(!supabaseClient)return;const blockId=document.getElementById('bulk_block_list').value;const startNumber=document.getElementById('bulk_start_number').value.trim();const quantity=parseInt(document.getElementById('bulk_quantity').value);const thickness=document.getElementById('bulk_thick').value;const lcm=parseFloat(document.getElementById('bulk_l_cm').value);const hcm=parseFloat(document.getElementById('bulk_h_cm').value);if(!blockId||!startNumber||!quantity||!lcm||!hcm){alert('Fill all fields');return}if(quantity>100){if(!confirm(`You're about to create ${quantity} slabs. Continue?`))return}const lin=lcm/2.54;const hin=hcm/2.54;const sq=(lin*hin)/144;const match=startNumber.match(/^(.*?)(\d+)$/);if(!match){alert('Slab number must end with a number (e.g., SLAB-001)');return}const prefix=match[1];const startNum=parseInt(match[2]);const padding=match[2].length;try{const[lotId,blockIdOnly]=blockId.split('-');await supabaseClient.from('blocks').update({processing_status:'PROCESSING'}).eq('lot_id',lotId).eq('block_id',blockIdOnly);const slabs=[];for(let i=0;i<quantity;i++){const num=(startNum+i).toString().padStart(padding,'0');const slabNumber=prefix+num;slabs.push({block_id:blockId,slab_number:slabNumber,status:'RAW',raw_length:lin.toFixed(2),raw_height:hin.toFixed(2),raw_length_cm:lcm,raw_height_cm:hcm,raw_sqft:sq.toFixed(2),thickness:thickness})}const{error}=await supabaseClient.from('slabs').insert(slabs);if(error)throw error;document.getElementById('bulk_start_number').value='';document.getElementById('bulk_quantity').value='';document.getElementById('bulk_l_cm').value='';document.getElementById('bulk_h_cm').value='';document.getElementById('bulk_l_in').innerText='0';document.getElementById('bulk_h_in').innerText='0';document.getElementById('bulk_preview').innerHTML='Enter details above';await refreshData();alert(`‚úÖ Successfully created ${quantity} slabs!`)}catch(error){alert('Error: '+error.message)}}

let currentEditType='';let currentEditData=null;function closeEditModal(){document.getElementById('edit_modal').classList.remove('active');currentEditType='';currentEditData=null}document.addEventListener('click',(e)=>{const modal=document.getElementById('edit_modal');if(e.target===modal){closeEditModal()}});async function editLot(lotId){const lot=globalData.lots.find(l=>l.lot_id===lotId);if(!lot)return;currentEditType='Lot';currentEditData=lot;document.getElementById('edit_modal_title').textContent='‚úèÔ∏è Edit Lot';document.getElementById('edit_modal_content').innerHTML=`<input type="hidden" id="edit_lot_id" value="${lot.lot_id}"><label class="label-sm">Lot ID</label><input type="text" value="${lot.lot_id}" readonly style="background:var(--bg-secondary)"><label class="label-sm">Cost (Lakhs)</label><input type="number" id="edit_lot_cost" value="${lot.cost}" step="0.01">`;document.getElementById('save_edit_btn').onclick=saveLotEdit;document.getElementById('edit_modal').classList.add('active')}async function saveLotEdit(){const lotId=document.getElementById('edit_lot_id').value;const cost=parseFloat(document.getElementById('edit_lot_cost').value);if(!cost){alert('Enter cost');return}try{await supabaseClient.from('lots').update({cost:cost}).eq('lot_id',lotId);closeEditModal();await refreshData();alert('‚úÖ Lot updated!')}catch(error){alert('Error: '+error.message)}}async function editBlock(lotId,blockId){const block=globalData.blocks.find(b=>b.lot_id===lotId&&b.block_id===blockId);if(!block)return;currentEditType='Block';currentEditData=block;document.getElementById('edit_modal_title').textContent='‚úèÔ∏è Edit Block';document.getElementById('edit_modal_content').innerHTML=`<input type="hidden" id="edit_block_lot_id" value="${lotId}"><input type="hidden" id="edit_block_id" value="${blockId}"><label class="label-sm">Block: ${lotId}-${blockId}</label><div class="section-header" style="color:var(--blue);font-size:11px;margin-top:12px">Original Dimensions</div><div class="grid-3"><div><label class="label-sm">L (cm)</label><input type="number" id="edit_orig_l" value="${block.original_length||''}"></div><div><label class="label-sm">H (cm)</label><input type="number" id="edit_orig_h" value="${block.original_height||''}"></div><div><label class="label-sm">W (cm)</label><input type="number" id="edit_orig_w" value="${block.original_width||''}"></div></div><div class="section-header" style="color:var(--neon);font-size:11px;margin-top:12px">Usable Dimensions</div><div class="grid-3"><div><label class="label-sm">L (cm)</label><input type="number" id="edit_use_l" value="${block.usable_length||''}"></div><div><label class="label-sm">H (cm)</label><input type="number" id="edit_use_h" value="${block.usable_height||''}"></div><div><label class="label-sm">W (cm)</label><input type="number" id="edit_use_w" value="${block.usable_width||''}"></div></div>`;document.getElementById('save_edit_btn').onclick=saveBlockEdit;document.getElementById('edit_modal').classList.add('active')}async function saveBlockEdit(){const lotId=document.getElementById('edit_block_lot_id').value;const blockId=document.getElementById('edit_block_id').value;const origL=parseFloat(document.getElementById('edit_orig_l').value);const origH=parseFloat(document.getElementById('edit_orig_h').value);const origW=parseFloat(document.getElementById('edit_orig_w').value);const useL=parseFloat(document.getElementById('edit_use_l').value);const useH=parseFloat(document.getElementById('edit_use_h').value);const useW=parseFloat(document.getElementById('edit_use_w').value);if(!origL||!origH||!origW||!useL||!useH||!useW){alert('Fill all dimensions');return}const origVol=(origL*origH*origW)/1000000;const useVol=(useL*useH*useW)/1000000;try{await supabaseClient.from('blocks').update({original_length:origL,original_height:origH,original_width:origW,original_volume:origVol.toFixed(3),usable_length:useL,usable_height:useH,usable_width:useW,usable_volume:useVol.toFixed(3)}).eq('lot_id',lotId).eq('block_id',blockId);closeEditModal();await refreshData();alert('‚úÖ Block updated!')}catch(error){alert('Error: '+error.message)}}async function editSlab(slabId){const slab=globalData.slabs.find(s=>s.id===slabId);if(!slab)return;const isRAW=slab.status==='RAW';currentEditType=isRAW?'RAW Slab':'POLISHED Slab';currentEditData=slab;document.getElementById('edit_modal_title').textContent=`‚úèÔ∏è Edit ${isRAW?'Raw':'Polished'} Slab`;if(isRAW){document.getElementById('edit_modal_content').innerHTML=`<input type="hidden" id="edit_slab_id" value="${slab.id}"><label class="label-sm">Slab Number</label><input type="text" id="edit_slab_number" value="${slab.slab_number}"><label class="label-sm">Thickness</label><select id="edit_slab_thickness"><option value="2cm" ${slab.thickness==='2cm'?'selected':''}>2 cm</option><option value="3cm" ${slab.thickness==='3cm'?'selected':''}>3 cm</option></select><div class="grid-2"><div><label class="label-sm">Length (cm)</label><input type="number" id="edit_raw_l_cm" value="${slab.raw_length_cm}" step="0.1"></div><div><label class="label-sm">Height (cm)</label><input type="number" id="edit_raw_h_cm" value="${slab.raw_height_cm}" step="0.1"></div></div>`}else{const grades=JSON.parse(localStorage.getItem('quality_grades')||JSON.stringify([{name:'Premium 2cm',rate:150,thickness:'2cm'},{name:'Premium 3cm',rate:200,thickness:'3cm'},{name:'Standard 2cm',rate:100,thickness:'2cm'},{name:'Standard 3cm',rate:130,thickness:'3cm'},{name:'Commercial',rate:75,thickness:'2cm'}]));const gradeOptions=grades.map(g=>`<option value="${g.rate}" ${g.rate==slab.rate?'selected':''}>${g.name} (Rs. ${g.rate}/sqft)</option>`).join('');document.getElementById('edit_modal_content').innerHTML=`<input type="hidden" id="edit_slab_id" value="${slab.id}"><label class="label-sm">Slab Number</label><input type="text" id="edit_slab_number" value="${slab.slab_number}"><div class="calc-box" style="border-left-color:var(--orange);margin:12px 0;padding:12px"><div style="font-size:11px;color:var(--text-secondary)">Raw Dimensions</div><div style="font-size:13px;color:var(--neon);margin-top:4px">${slab.raw_length_cm} √ó ${slab.raw_height_cm} cm = ${slab.raw_sqft} sqft</div></div><label class="label-sm">Thickness</label><select id="edit_slab_thickness"><option value="2cm" ${slab.thickness==='2cm'?'selected':''}>2 cm</option><option value="3cm" ${slab.thickness==='3cm'?'selected':''}>3 cm</option></select><div class="grid-2"><div><label class="label-sm">Polished Length (cm)</label><input type="number" id="edit_polish_l_cm" value="${slab.polished_length_cm}" step="0.1"></div><div><label class="label-sm">Polished Height (cm)</label><input type="number" id="edit_polish_h_cm" value="${slab.polished_height_cm}" step="0.1"></div></div><label class="label-sm">Quality/Rate</label><select id="edit_polish_rate">${gradeOptions}</select>`}document.getElementById('save_edit_btn').onclick=saveSlabEdit;document.getElementById('edit_modal').classList.add('active')}async function saveSlabEdit(){const slabId=document.getElementById('edit_slab_id').value;const slabNumber=document.getElementById('edit_slab_number').value.trim();const thickness=document.getElementById('edit_slab_thickness').value;if(!slabNumber){alert('Enter slab number');return}try{if(currentEditType==='RAW Slab'){const lcm=parseFloat(document.getElementById('edit_raw_l_cm').value);const hcm=parseFloat(document.getElementById('edit_raw_h_cm').value);if(!lcm||!hcm){alert('Fill dimensions');return}const lin=lcm/2.54;const hin=hcm/2.54;const sqft=(lin*hin)/144;await supabaseClient.from('slabs').update({slab_number:slabNumber,thickness:thickness,raw_length:lin.toFixed(2),raw_height:hin.toFixed(2),raw_length_cm:lcm,raw_height_cm:hcm,raw_sqft:sqft.toFixed(2)}).eq('id',slabId)}else{const lcm=parseFloat(document.getElementById('edit_polish_l_cm').value);const hcm=parseFloat(document.getElementById('edit_polish_h_cm').value);const rate=parseFloat(document.getElementById('edit_polish_rate').value);if(!lcm||!hcm){alert('Fill dimensions');return}const lin=lcm/2.54;const hin=hcm/2.54;const sqft=(lin*hin)/144;const value=sqft*rate;await supabaseClient.from('slabs').update({slab_number:slabNumber,thickness:thickness,polished_length:lin.toFixed(2),polished_height:hin.toFixed(2),polished_length_cm:lcm,polished_height_cm:hcm,polished_sqft:sqft.toFixed(2),rate:rate,value:value.toFixed(0)}).eq('id',slabId)}closeEditModal();await refreshData();alert('‚úÖ Slab updated!')}catch(error){alert('Error: '+error.message)}}


</script>
</body>
</html>
