<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEIPL - Global Inspection V9.0</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print, .hide-on-report { display: none !important; }
            body { background: white; padding: 0; margin: 0; }
            .report-box { border: 1px solid #000 !important; box-shadow: none !important; margin-bottom: 10px !important; }
            th, td { border: 1px solid #e2e8f0 !important; padding: 4px; font-size: 8px !important; }
            .print-photo { width: 70px !important; height: 50px !important; object-fit: cover; border: 0.5px solid #ccc; }
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        function App() {
            const [header, setHeader] = useState(() => {
                const saved = localStorage.getItem('keipl_h_v90');
                return saved ? JSON.parse(saved) : { 
                    customer: '', container: '', factory: '', destination: '', 
                    colour: '', marker: '', supervisor: '', defThick: '2', allowance: '0',
                    reportNo: '', invoiceNo: '', inspectDate: new Date().toISOString().split('T')[0]
                };
            });

            const [entries, setEntries] = useState(() => {
                const saved = localStorage.getItem('keipl_e_v90');
                return saved ? JSON.parse(saved) : [];
            });

            const [current, setCurrent] = useState({ gL:'', gW:'', nL:'', nW:'', photo: null });
            const [bulkText, setBulkText] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [filterRange, setFilterRange] = useState('All');
            const [showPhotosInPrint, setShowPhotosInPrint] = useState(true);

            useEffect(() => { localStorage.setItem('keipl_h_v90', JSON.stringify(header)); }, [header]);
            useEffect(() => { localStorage.setItem('keipl_e_v90', JSON.stringify(entries)); }, [entries]);

            const handleGrossInput = (field, val) => {
                const num = parseFloat(val) || 0;
                const ded = parseFloat(header.allowance) || 0;
                const net = num > ded ? num - ded : num;
                setCurrent(p => ({ ...p, [field]: val, [field==='gL'?'nL':'nW']: net.toString() }));
            };

            const addOrUpdate = () => {
                if (!current.gL || !current.gW) return;
                const gS = (parseFloat(current.gL)*parseFloat(current.gW))/10000;
                const nS = (parseFloat(current.nL)*parseFloat(current.nW))/10000;
                const kg = (gS * (parseFloat(header.defThick)/100) * 2850).toFixed(0);
                const absAll = (gS - nS).toFixed(3);

                if (editingId) {
                    setEntries(entries.map(e => e.id === editingId ? { ...e, ...current, gSqm: gS.toFixed(3), nSqm: nS.toFixed(3), wt: kg, absAll } : e));
                    setEditingId(null);
                } else {
                    const newSlab = {
                        ...current, id: Date.now(),
                        slabNo: `KEIPL/${(entries.length + 1).toString().padStart(2, '0')}`,
                        gSqm: gS.toFixed(3), nSqm: nS.toFixed(3), wt: kg, absAll, 
                        allType: header.allowance, thick: header.defThick
                    };
                    setEntries([newSlab, ...entries]);
                }
                setCurrent({ gL:'', gW:'', nL:'', nW:'', photo: null });
            };

            const processBulk = () => {
                const rows = bulkText.trim().split('\n');
                const newEnts = rows.map((row, i) => {
                    const cols = row.split(/\t|,/);
                    const gl = cols[0]; const gw = cols[1];
                    if (!gl || isNaN(gl)) return null;
                    const nl = cols[2] || (gl - header.allowance);
                    const nw = cols[3] || (gw - header.allowance);
                    const gS = (parseFloat(gl)*parseFloat(gw))/10000;
                    const nS = (parseFloat(nl)*parseFloat(nw))/10000;
                    return {
                        id: Date.now() + i, slabNo: `KEIPL/${(entries.length + i + 1).toString().padStart(2, '0')}`,
                        gL:gl, gW:gw, nL:nl, nW:nw, gSqm: gS.toFixed(3), nSqm: nS.toFixed(3),
                        wt: (gS * (header.defThick/100) * 2850).toFixed(0), absAll: (gS-nS).toFixed(3), 
                        allType: header.allowance, thick: header.defThick
                    };
                }).filter(x => x);
                setEntries([...newEnts, ...entries]);
                setBulkText('');
            };

            const stats = useMemo(() => {
                const totalG = entries.reduce((a, b) => a + parseFloat(b.gSqm), 0);
                const totalN = entries.reduce((a, b) => a + parseFloat(b.nSqm), 0);
                const totalW = entries.reduce((a, b) => a + parseFloat(b.wt), 0);
                const cat = { below200: 0, over200: 0, over250: 0, over300: 0 };
                entries.forEach(e => {
                    const l = parseFloat(e.nL);
                    if (l >= 300) cat.over300++; else if (l >= 250) cat.over250++;
                    else if (l >= 200) cat.over200++; else cat.below200++;
                });
                const getPct = (val) => entries.length > 0 ? ((val / entries.length) * 100).toFixed(0) : 0;
                return { 
                    gArea: totalG.toFixed(3), nArea: totalN.toFixed(3), 
                    absAllow: (totalG - totalN).toFixed(3),
                    pctAllow: totalG > 0 ? (((totalG - totalN) / totalG) * 100).toFixed(2) : 0,
                    mt: (totalW / 1000).toFixed(3), cat,
                    catPct: { below200: getPct(cat.below200), over200: getPct(cat.over200), over250: getPct(cat.over250), over300: getPct(cat.over300) }
                };
            }, [entries]);

            const filteredEntries = entries.filter(e => {
                const l = parseFloat(e.nL);
                if (filterRange === '300+') return l >= 300;
                if (filterRange === '250+') return l >= 250 && l < 300;
                if (filterRange === '200+') return l >= 200 && l < 250;
                if (filterRange === 'Below 200') return l < 200;
                return true;
            });

            return (
                <div className="max-w-7xl mx-auto p-4 md:py-6">
                    {/* TOP ACTION BAR */}
                    <div className="flex flex-wrap justify-between items-center gap-4 mb-6 no-print">
                        <div className="flex gap-2">
                             <button onClick={() => {if(confirm("Clear Slabs?")) setEntries([]);}} className="bg-white text-red-600 px-4 py-2 rounded-lg text-[10px] font-black uppercase border border-red-200 shadow-sm">Clear Table</button>
                             <div className="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border shadow-sm">
                                <span className="text-[9px] font-black uppercase text-slate-500">Show Photos:</span>
                                <input type="checkbox" checked={showPhotosInPrint} onChange={(e) => setShowPhotosInPrint(e.target.checked)} className="w-4 h-4" />
                             </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => window.print()} className="bg-blue-900 text-white px-8 py-2.5 rounded-lg text-[10px] font-black uppercase shadow-lg border-b-4 border-blue-950">Print PDF Report</button>
                        </div>
                    </div>

                    {/* HEADER SECTION */}
                    <div className="bg-white p-8 border-t-[12px] border-blue-900 shadow-md mb-6 report-box rounded-xl">
                        <div className="flex justify-between items-start mb-8">
                            <div>
                                <h1 className="text-5xl font-black text-blue-900 tracking-tighter leading-none">KUIPER</h1>
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-[0.3em] mt-2">Quality Inspection System</p>
                            </div>
                            <div className="text-right space-y-2">
                                <div className="inline-block border-b-2 border-slate-100 p-1">
                                    <label className="text-[9px] font-black text-slate-400 block uppercase">Insp. Date</label>
                                    <input type="date" className="font-bold text-sm outline-none bg-transparent" value={header.inspectDate} onChange={e => setHeader({...header, inspectDate: e.target.value})} />
                                </div>
                                <p className="text-xs font-black text-blue-900 bg-blue-50 px-3 py-1 rounded">REF: {header.reportNo || 'NEW-REPORT'}</p>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-6">
                            {['customer', 'container', 'factory', 'destination', 'colour', 'marker', 'supervisor', 'defThick', 'reportNo', 'invoiceNo'].map(k => (
                                <div key={k} className={`border-b-2 border-slate-50 pb-1 hover:border-blue-200 transition-colors ${k === 'factory' ? 'hide-on-report' : ''}`}>
                                    <label className="block text-[9px] font-black text-slate-400 uppercase tracking-tight mb-1">{k}</label>
                                    <input className="w-full font-bold text-xs outline-none uppercase bg-transparent text-slate-800" value={header[k]} onChange={e => setHeader({...header, [k]: e.target.value})} />
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* INPUTS ROW: BULK + MANUAL */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 no-print mb-8">
                        {/* RESTORED BULK PASTE */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 lg:col-span-2">
                             <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xs font-black uppercase text-slate-600 tracking-widest">Bulk Import Slabs</h3>
                                <span className="text-[10px] text-slate-400 font-medium">Format: GL, GW, NL, NW</span>
                             </div>
                             <textarea 
                                className="w-full h-32 p-4 text-xs font-mono border-2 border-dashed border-slate-200 rounded-xl outline-none focus:border-blue-400 bg-slate-50 transition-all" 
                                placeholder="Paste Excel data here (e.g. 320   180   318   178)..." 
                                value={bulkText} 
                                onChange={e => setBulkText(e.target.value)}
                             ></textarea>
                             <div className="mt-4 flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <label className="text-[10px] font-black text-blue-600 uppercase">Apply Allw:</label>
                                    <select className="font-bold text-xs bg-slate-100 p-2 rounded" value={header.allowance} onChange={e => setHeader({...header, allowance: e.target.value})}>
                                        <option value="0">None</option><option value="2">2 cm</option><option value="3">3 cm</option><option value="5">5 cm</option>
                                    </select>
                                </div>
                                <button onClick={processBulk} className="bg-slate-800 text-white px-10 py-3 rounded-xl text-[11px] font-black uppercase tracking-wider hover:bg-black transition-all shadow-lg">Import Batch</button>
                             </div>
                        </div>

                        {/* MANUAL ENTRY */}
                        <div className="bg-slate-900 text-white p-6 rounded-2xl shadow-xl border-t-8 border-blue-500">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-xs font-black text-blue-400 uppercase tracking-widest italic">Manual Entry</h3>
                                <span className="bg-blue-600 text-[10px] px-2 py-1 rounded">Slab {entries.length + 1}</span>
                            </div>
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-3">
                                    <input type="number" placeholder="Gross L" className="p-3 rounded-lg text-black font-black w-full" value={current.gL} onChange={e => handleGrossInput('gL', e.target.value)} />
                                    <input type="number" placeholder="Gross W" className="p-3 rounded-lg text-black font-black w-full" value={current.gW} onChange={e => handleGrossInput('gW', e.target.value)} />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <input type="number" placeholder="Net L" className="p-3 rounded-lg bg-green-50 text-black font-black w-full border-2 border-green-300" value={current.nL} onChange={e => setCurrent({...current, nL: e.target.value})} />
                                    <input type="number" placeholder="Net W" className="p-3 rounded-lg bg-green-50 text-black font-black w-full border-2 border-green-300" value={current.nW} onChange={e => setCurrent({...current, nW: e.target.value})} />
                                </div>
                                <div className="flex items-center gap-2">
                                    <input type="file" accept="image/*" className="hidden" id="file-up" onChange={(e) => {
                                        const reader = new FileReader();
                                        reader.onloadend = () => setCurrent(p => ({ ...p, photo: reader.result }));
                                        reader.readAsDataURL(e.target.files[0]);
                                    }} />
                                    <label htmlFor="file-up" className="cursor-pointer bg-slate-700 hover:bg-slate-600 p-3 rounded-lg flex-1 text-center text-[10px] font-bold uppercase">
                                        {current.photo ? "âœ“ Photo Added" : "ðŸ“· Add Photo"}
                                    </label>
                                    {current.photo && <button onClick={() => setCurrent(p => ({...p, photo:null}))} className="text-red-400 font-bold">âœ•</button>}
                                </div>
                            </div>
                            <button onClick={addOrUpdate} className="bg-blue-600 mt-6 py-4 rounded-xl font-black uppercase text-sm w-full shadow-lg hover:bg-blue-500 transition-all">Save Slab</button>
                        </div>
                    </div>

                    {/* SLAB ANALYTICS BAR */}
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
                        <div onClick={() => setFilterRange('All')} className={`p-4 rounded-xl border-2 print-card cursor-pointer transition-all ${filterRange === 'All' ? 'border-blue-600 bg-blue-50 shadow-md' : 'bg-white border-transparent shadow-sm'}`}>
                            <p className="text-[10px] font-black text-slate-400 uppercase">Total Slabs</p>
                            <p className="text-3xl font-black text-blue-900 leading-none mt-1">{entries.length}</p>
                        </div>
                        {[{ label: '300+', key: 'over300' }, { label: '250+', key: 'over250' }, { label: '200+', key: 'over200' }, { label: 'Below 200', key: 'below200' }].map(f => (
                            <div key={f.label} onClick={() => setFilterRange(f.label)} className={`p-4 rounded-xl border-2 print-card cursor-pointer transition-all ${filterRange === f.label ? 'border-blue-600 bg-blue-50 shadow-md' : 'bg-white border-transparent shadow-sm'}`}>
                                <p className="text-[10px] font-black text-slate-400 uppercase">{f.label} cm</p>
                                <p className="text-3xl font-black text-slate-800 leading-none mt-1">{stats.cat[f.key]}</p>
                                <p className="text-[10px] font-bold text-blue-400 mt-2">{stats.catPct[f.key]}% Ratio</p>
                            </div>
                        ))}
                    </div>

                    {/* MAIN DATA TABLE */}
                    <div className="bg-white border shadow-sm report-box overflow-hidden rounded-xl">
                        <table className="w-full text-center border-collapse">
                            <thead>
                                <tr className="bg-slate-800 text-white text-[9px] uppercase tracking-wider">
                                    <th className="p-3 text-left">Slab No</th>
                                    {showPhotosInPrint && <th className="p-3">Slab Visual</th>}
                                    <th className="p-3">Gross (L x W)</th>
                                    <th className="p-3">Gross mÂ²</th>
                                    <th className="p-3 bg-blue-900/50">Allow (cm)</th>
                                    <th className="p-3 bg-red-900/50">Allow (mÂ²)</th>
                                    <th className="p-3 bg-green-800">Net Dim</th>
                                    <th className="p-3 bg-blue-800">Net mÂ²</th>
                                    <th className="p-3 no-print">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filteredEntries.map(e => (
                                    <tr key={e.id} className="text-[10px] hover:bg-slate-50 transition-colors">
                                        <td className="p-3 text-left font-black text-blue-900 italic uppercase">{e.slabNo}</td>
                                        {showPhotosInPrint && (
                                            <td className="p-1">
                                                {e.photo ? <img src={e.photo} className="print-photo mx-auto rounded shadow-sm border" /> : <span className="text-slate-300 text-[8px]">NONE</span>}
                                            </td>
                                        )}
                                        <td className="p-3 text-slate-400 font-mono">{e.gL}x{e.gW}</td>
                                        <td className="p-3 text-slate-400">{e.gSqm}</td>
                                        <td className="p-3 font-bold text-blue-600">{e.allType} cm</td>
                                        <td className="p-3 font-bold text-red-500 italic">{e.absAll}</td>
                                        <td className="p-3 font-black text-green-700 font-mono">{e.nL}x{e.nW}</td>
                                        <td className="p-3 font-black text-blue-900">{e.nSqm}</td>
                                        <td className="p-3 no-print">
                                            <div className="flex gap-2 justify-center">
                                                <button onClick={() => {setEditingId(e.id); setCurrent(e); window.scrollTo(0,0);}} className="text-blue-600 font-bold">Edit</button>
                                                <button onClick={() => setEntries(entries.filter(x => x.id !== e.id))} className="text-red-300">âœ•</button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* FINAL SUMMARY DASHBOARD */}
                    <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6 border-t-8 border-blue-900 pt-8 pb-20">
                        <div className="bg-blue-900 text-white p-8 rounded-3xl shadow-xl flex justify-between items-center border-r-8 border-green-500">
                            <div><p className="text-[10px] font-black uppercase opacity-60 tracking-widest">Net Payable Area</p><p className="text-5xl font-black leading-none">{stats.nArea} <span className="text-sm font-normal">mÂ²</span></p></div>
                            <div className="text-right"><p className="text-[10px] font-black uppercase opacity-60 tracking-widest">Total Weight</p><p className="text-3xl font-black text-green-400">{stats.mt} <span className="text-sm font-normal">MT</span></p></div>
                        </div>

                        <div className="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-center">
                            <div className="flex justify-between border-b pb-3 mb-3"><span className="text-[11px] font-black text-slate-400 uppercase">Gross Surface Area</span><span className="font-bold text-slate-700">{stats.gArea} mÂ²</span></div>
                            <div className="flex justify-between items-center"><span className="text-[11px] font-black text-red-500 uppercase">Allow. Deduction</span><span className="text-4xl font-black text-red-600">{stats.pctAllow}%</span></div>
                            <p className="text-[9px] text-center mt-2 font-bold text-slate-400 tracking-tighter uppercase italic">Absolute Allowance: {stats.absAllow} mÂ²</p>
                        </div>

                        <div className="flex flex-col justify-end items-end pr-6">
                            <div className="text-right">
                                <p className="text-[11px] font-black text-slate-400 uppercase mb-8 tracking-[0.2em] italic">Official Inspector Signature</p>
                                <div className="border-b-4 border-slate-900 w-64 mb-3"></div>
                                <p className="font-black text-lg uppercase text-blue-900 tracking-widest italic">{header.supervisor || 'AUTHORIZED AGENT'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
