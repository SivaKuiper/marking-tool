<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEIPL - Professional Inspection Tool</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .report-container { border: none !important; box-shadow: none !important; }
            table { border-collapse: collapse; width: 100%; border: 1px solid black !important; }
            th, td { border: 1px solid black !important; padding: 4px; font-size: 9px !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        function App() {
            // State Management
            const [header, setHeader] = useState(() => {
                const saved = localStorage.getItem('keipl_header_v7');
                return saved ? JSON.parse(saved) : { marker: '', supervisor: '', container: '', colour: '', defThickness: '2', allowance: '0' };
            });

            const [entries, setEntries] = useState(() => {
                const saved = localStorage.getItem('keipl_entries_v7');
                return saved ? JSON.parse(saved) : [];
            });

            const [current, setCurrent] = useState({ gL: '', gW: '', nL: '', nW: '', photo: null });

            // Auto-Save
            useEffect(() => { localStorage.setItem('keipl_header_v7', JSON.stringify(header)); }, [header]);
            useEffect(() => { localStorage.setItem('keipl_entries_v7', JSON.stringify(entries)); }, [entries]);

            // Auto-Allowance Calculation
            const handleGrossInput = (field, value) => {
                const num = parseFloat(value) || 0;
                const deduct = parseFloat(header.allowance) || 0;
                const net = num > deduct ? num - deduct : num;

                setCurrent(prev => ({
                    ...prev,
                    [field]: value,
                    [field === 'gL' ? 'nL' : 'nW']: net.toString()
                }));
            };

            const addEntry = () => {
                if (!current.gL || !current.gW) return alert("Please enter dimensions");
                
                const gSqm = (parseFloat(current.gL) * parseFloat(current.gW)) / 10000;
                const nSqm = (parseFloat(current.nL) * parseFloat(current.nW)) / 10000;
                const weight = (gSqm * (parseFloat(header.defThickness) / 100) * 2850).toFixed(0);

                const newSlab = {
                    ...current,
                    id: Date.now(),
                    slabNo: `KEIPL/${(entries.length + 1).toString().padStart(2, '0')}`,
                    gSqm: gSqm.toFixed(3),
                    nSqm: nSqm.toFixed(3),
                    weight: weight,
                    thick: header.defThickness
                };

                setEntries([newSlab, ...entries]);
                setCurrent({ gL: '', gW: '', nL: '', nW: '', photo: null });
            };

            const downloadExcel = () => {
                let csv = "Slab No,Gross L,Gross W,Net L,Net W,Thick,Net SQM,Weight KG\n";
                entries.forEach(e => {
                    csv += `${e.slabNo},${e.gL},${e.gW},${e.nL},${e.nW},${e.thick},${e.nSqm},${e.weight}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `KEIPL_${header.container || 'Report'}.csv`;
                a.click();
            };

            const totals = useMemo(() => {
                const netArea = entries.reduce((acc, e) => acc + parseFloat(e.nSqm), 0);
                const totalWeight = entries.reduce((acc, e) => acc + parseFloat(e.weight), 0);
                return { area: netArea.toFixed(3), mt: (totalWeight / 1000).toFixed(3) };
            }, [entries]);

            return (
                <div className="max-w-5xl mx-auto p-4 md:p-8 report-container">
                    {/* Header Section */}
                    <div className="bg-white p-6 border-b-4 border-blue-900 shadow-sm mb-6">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h1 className="text-3xl font-black text-blue-900 tracking-tighter">KUIPER</h1>
                                <p className="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Exports & Imports Pvt Ltd</p>
                            </div>
                            <div className="flex gap-2 no-print">
                                <button onClick={downloadExcel} className="bg-green-600 text-white px-4 py-2 rounded text-xs font-bold uppercase hover:bg-green-700">Download Excel</button>
                                <button onClick={() => window.print()} className="bg-blue-900 text-white px-4 py-2 rounded text-xs font-bold uppercase">Print PDF</button>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
                            {['marker', 'supervisor', 'container', 'colour', 'defThickness'].map(key => (
                                <div key={key}>
                                    <label className="block text-[9px] font-bold text-gray-400 uppercase">{key === 'defThickness' ? 'Thick (cm)' : key}</label>
                                    <input className="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none focus:border-blue-500" 
                                           value={header[key]} onChange={e => setHeader({...header, [key]: e.target.value})} />
                                </div>
                            ))}
                            <div>
                                <label className="block text-[9px] font-bold text-blue-600 uppercase">Auto-Allowance</label>
                                <select className="w-full border-b border-gray-300 py-1 text-sm font-bold outline-none" 
                                        value={header.allowance} onChange={e => setHeader({...header, allowance: e.target.value})}>
                                    <option value="0">0 cm</option>
                                    <option value="2">2 cm</option>
                                    <option value="3">3 cm</option>
                                    <option value="5">5 cm</option>
                                    <option value="10">10 cm</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Input Section */}
                    <div className="no-print bg-slate-800 p-6 rounded-xl shadow-lg mb-8 text-white">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase mb-2">Gross Dimensions (cm)</label>
                                <div className="flex gap-2">
                                    <input type="number" placeholder="L" className="w-full p-2 rounded text-black font-bold" 
                                           value={current.gL} onChange={e => handleGrossInput('gL', e.target.value)} />
                                    <input type="number" placeholder="W" className="w-full p-2 rounded text-black font-bold" 
                                           value={current.gW} onChange={e => handleGrossInput('gW', e.target.value)} />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-green-400 uppercase mb-2">Net Dimensions (Calculated)</label>
                                <div className="flex gap-2">
                                    <input type="number" className="w-full p-2 rounded bg-green-50 text-black font-bold" 
                                           value={current.nL} onChange={e => setCurrent({...current, nL: e.target.value})} />
                                    <input type="number" className="w-full p-2 rounded bg-green-50 text-black font-bold" 
                                           value={current.nW} onChange={e => setCurrent({...current, nW: e.target.value})} />
                                </div>
                            </div>
                            <button onClick={addEntry} className="bg-blue-600 hover:bg-blue-500 text-white font-black py-3 rounded uppercase transition-all shadow-lg">Add Slab</button>
                        </div>
                    </div>

                    {/* Table Section */}
                    <div className="bg-white shadow-sm border border-gray-200 overflow-hidden">
                        <table className="w-full border-collapse">
                            <thead className="bg-gray-50 border-b">
                                <tr className="text-[10px] uppercase text-gray-500 tracking-wider">
                                    <th className="p-3 text-left">Slab No</th>
                                    <th className="p-3 text-center">Gross (L x W)</th>
                                    <th className="p-3 text-center text-green-700">Net (L x W)</th>
                                    <th className="p-3 text-center">Net Area</th>
                                    <th className="p-3 text-center">Weight</th>
                                    <th className="p-3 text-right no-print">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {entries.map(e => (
                                    <tr key={e.id} className="hover:bg-gray-50">
                                        <td className="p-3 font-black text-blue-900">{e.slabNo}</td>
                                        <td className="p-3 text-center text-xs text-gray-400">{e.gL} x {e.gW}</td>
                                        <td className="p-3 text-center text-xs font-bold text-green-700">{e.nL} x {e.nW}</td>
                                        <td className="p-3 text-center text-xs font-bold">{e.nSqm} m²</td>
                                        <td className="p-3 text-center text-xs text-gray-500 font-mono">{e.weight} kg</td>
                                        <td className="p-3 text-right no-print">
                                            <button onClick={() => setEntries(entries.filter(x => x.id !== e.id))} className="text-red-400 hover:text-red-600 font-bold">✕</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* Footer Summary */}
                    <div className="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8 items-end">
                        <div className="bg-blue-900 p-6 rounded text-white flex justify-between items-center shadow-lg">
                            <div>
                                <p className="text-[10px] font-bold uppercase opacity-60">Total Container Payload</p>
                                <p className="text-3xl font-black">{totals.area} m²</p>
                            </div>
                            <div className="text-right">
                                <p className="text-[10px] font-bold uppercase opacity-60">Gross Weight</p>
                                <p className="text-2xl font-black text-green-400">{totals.mt} MT</p>
                            </div>
                        </div>
                        <div className="text-right pr-4">
                            <p className="text-xs font-bold uppercase text-gray-400 mb-1">Supervisor Verification</p>
                            <p className="text-sm font-black border-t-2 border-gray-900 pt-1 inline-block min-w-[150px] uppercase tracking-widest">{header.supervisor || 'Pending signature'}</p>
                        </div>
                    </div>

                    <div className="mt-12 text-center no-print">
                        <button onClick={() => { if(confirm("Clear everything?")) { localStorage.clear(); location.reload(); } }} className="text-[10px] font-bold text-red-400 underline uppercase tracking-widest">Factory Reset System</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
