<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEIPL - Professional Inspection Tool</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            table { border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #000 !important; padding: 4px; font-size: 8px; }
            .print-photo { width: 50px; height: 50px; object-fit: cover; }
        }
        .table-outline { border: 1px solid #000; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        function App() {
            const [header, setHeader] = useState(() => {
                const saved = localStorage.getItem('keipl_v7_header');
                return saved ? JSON.parse(saved) : { marker: '', supervisor: '', container: '', colour: '', defThickness: '2', allowance: '0' };
            });

            const [entries, setEntries] = useState(() => {
                const saved = localStorage.getItem('keipl_v7_entries');
                return saved ? JSON.parse(saved) : [];
            });

            useEffect(() => { localStorage.setItem('keipl_v7_header', JSON.stringify(header)); }, [header]);
            useEffect(() => { localStorage.setItem('keipl_v7_entries', JSON.stringify(entries)); }, [entries]);

            const [current, setCurrent] = useState({ gL: '', gW: '', nL: '', nW: '', thick: '', photo: null });

            // AUTO ALLOWANCE LOGIC
            const handleGrossChange = (field, value) => {
                const numVal = parseFloat(value) || 0;
                const deduct = parseFloat(header.allowance) || 0;
                const netVal = numVal > deduct ? numVal - deduct : numVal;
                
                setCurrent(prev => ({
                    ...prev,
                    [field]: value,
                    [field === 'gL' ? 'nL' : 'nW']: netVal.toString()
                }));
            };

            const addOrUpdateSlab = () => {
                if (!current.gL || !current.gW) return alert("Enter dimensions");
                const activeThick = current.thick || header.defThickness || 2;
                const gSqm = (parseFloat(current.gL) * parseFloat(current.gW)) / 10000;
                const nSqm = (parseFloat(current.nL) * parseFloat(current.nW)) / 10000;
                const weightKg = gSqm * (parseFloat(activeThick) / 100) * 2850;

                const newSlab = {
                    ...current, id: Date.now(), thick: activeThick,
                    slabNo: `KEIPL/${(entries.length + 1).toString().padStart(2, '0')}`,
                    gSqm: gSqm.toFixed(3), nSqm: nSqm.toFixed(3), weight: weightKg.toFixed(0)
                };
                setEntries([newSlab, ...entries]);
                setCurrent({ gL: '', gW: '', nL: '', nW: '', thick: '', photo: null });
            };

            const downloadExcel = () => {
                let csv = `Slab No,Gross L,Gross W,Net L,Net W,Thick,Gross SQM,Net SQM,Weight KG\n`;
                entries.forEach(e => {
                    csv += `${e.slabNo},${e.gL},${e.gW},${e.nL},${e.nW},${e.thick},${e.gSqm},${e.nSqm},${e.weight}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `KEIPL_${header.container}.csv`;
                a.click();
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const rows = event.target.result.split('\n').slice(1);
                    const newEntries = rows.map((row, index) => {
                        const [gl, gw, nl, nw] = row.split(',');
                        if(!gl || !gw) return null;
                        const gSqm = (parseFloat(gl) * parseFloat(gw)) / 10000;
                        const nSqm = (parseFloat(nl || gl) * parseFloat(nw || gw)) / 10000;
                        return {
                            id: Date.now() + index, slabNo: `KEIPL/${(entries.length + index + 1).toString().padStart(2, '0')}`,
                            gL: gl, gW: gw, nL: nl || gl, nW: nw || gw, thick: header.defThickness,
                            gSqm: gSqm.toFixed(3), nSqm: nSqm.toFixed(3), weight: (gSqm * (header.defThickness/100) * 2850).toFixed(0)
                        };
                    }).filter(x => x);
                    setEntries([...newEntries, ...entries]);
                };
                reader.readAsText(file);
            };

            return (
                <div className="max-w-6xl mx-auto p-4 md:p-8">
                    {/* HEADER */}
                    <div className="bg-white border-2 border-black p-6 mb-4 shadow-sm">
                        <div className="flex justify-between items-center border-b pb-4 mb-4">
                            <div><h1 className="text-3xl font-black text-blue-900">KUIPER</h1><p className="text-[10px] font-bold text-slate-400">EXPORTS & IMPORTS PVT LTD</p></div>
                            <div className="flex gap-2 no-print">
                                <label className="bg-orange-500 text-white px-3 py-2 rounded text-[10px] font-bold cursor-pointer uppercase">Upload CSV <input type="file" className="hidden" onChange={handleFileUpload} accept=".csv"/></label>
                                <button onClick={downloadExcel} className="bg-green-700 text-white px-3 py-2 rounded text-[10px] font-bold uppercase">Excel</button>
                                <button onClick={() => window.print()} className="bg-blue-800 text-white px-3 py-2 rounded text-[10px] font-bold uppercase">PDF</button>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
                            {['marker', 'supervisor', 'container', 'colour'].map(k => (
                                <div key={k} className="border-b"><label className="block text-[8px] uppercase font-bold text-slate-400">{k}</label>
                                <input className="w-full font-bold outline-none text-xs" value={header[k]} onChange={e => setHeader({...header, [k]: e.target.value})} /></div>
                            ))}
                            <div className="border-b"><label className="block text-[8px] uppercase font-bold text-blue-500">Auto Allowance (cm)</label>
                                <select className="w-full font-bold text-xs outline-none" value={header.allowance} onChange={e => setHeader({...header, allowance: e.target.value})}>
                                    <option value="0">None</option><option value="2">2 cm</option><option value="3">3 cm</option><option value="5">5 cm</option><option value="10">10 cm</option>
                                </select>
                            </div>
                            <div className="border-b"><label className="block text-[8px] uppercase font-bold text-slate-400">Thick (cm)</label>
                            <input type="number" className="w-full font-bold outline-none text-xs" value={header.defThickness} onChange={e => setHeader({...header, defThickness: e.target.value})} /></div>
                        </div>
                    </div>

                    {/* ENTRY FORM */}
                    <div className="no-print bg-slate-900 text-white p-6 rounded-xl mb-6 shadow-xl border-l-8 border-blue-600">
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                            <div><label className="text-[9px] text-slate-400 uppercase font-black">Gross L x W</label>
                                <div className="flex gap-1 mt-1"><input type="number" placeholder="L" className="w-full p-2 text-black rounded font-black" value={current.gL} onChange={e => handleGrossChange('gL', e.target.value)} />
                                <input type="number" placeholder="W" className="w-full p-2 text-black rounded font-black" value={current.gW} onChange={e => handleGrossChange('gW', e.target.value)} /></div>
                            </div>
                            <div><label className="text-[9px] text-green-500 uppercase font-black">Net L x W</label>
                                <div className="flex gap-1 mt-1"><input type="number" className="w-full p-2 text-black rounded bg-green-50" value={current.nL} onChange={e => setCurrent({...current, nL: e.target.value})} />
                                <input type="number" className="w-full p-2 text-black rounded bg-green-50" value={current.nW} onChange={e => setCurrent({...current, nW: e.target.value})} /></div>
                            </div>
                            <div className="col-span-2 md:col-span-1"><label className="text-[9px] text-slate-400 uppercase font-black">Photo</label><input id="file-upload" type="file" onChange={handlePhoto} className="block w-full text-[10px] mt-1"/></div>
                            <button onClick={addOrUpdateSlab} className="bg-blue-600 font-black py-3 rounded uppercase text-sm col-span-2 md:col-span-1">Add Slab</button>
                        </div>
                    </div>

                    {/* TABLE */}
                    <div className="bg-white table-outline overflow-hidden rounded-sm mb-6">
                        <table className="w-full border-collapse">
                            <thead className="bg-slate-900 text-white text-[9px] uppercase tracking-widest">
                                <tr>
                                    <th className="p-2 text-left">Slab No</th>
                                    <th className="p-2 text-center">Gross (cm)</th>
                                    <th className="p-2 text-center">Net (cm)</th>
                                    <th className="p-2 text-center">Area (m²)</th>
                                    <th className="p-2 text-right no-print">Manage</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-200">
                                {entries.map((e) => (
                                    <tr key={e.id}>
                                        <td className="p-2 font-black text-blue-900">{e.slabNo}</td>
                                        <td className="p-2 text-center text-[10px]">{e.gL} x {e.gW}</td>
                                        <td className="p-2 text-center text-[10px] font-bold text-green-700">{e.nL} x {e.nW}</td>
                                        <td className="p-2 text-center text-[10px] font-bold">{e.nSqm}</td>
                                        <td className="p-2 text-right no-print"><button onClick={() => setEntries(entries.filter(x => x.id !== e.id))} className="text-red-400">✕</button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* SUMMARY */}
                    <div className="flex justify-between items-end border-t pt-4">
                        <div className="text-[10px] font-bold uppercase">
                            <p>Total Net: <span className="text-lg text-green-700">{totals.n} m²</span></p>
                            <p>Est Weight: <span className="text-lg text-blue-900">{totals.mt} MT</span></p>
                        </div>
                        <div className="text-right border-t border-black w-48 no-print">
                            <p className="text-[9px] font-bold uppercase mt-1">Supervisor: {header.supervisor || "______"}</p>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
