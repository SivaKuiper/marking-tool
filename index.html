<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEIPL - Professional Packing List System</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .report-box { border: 1px solid #000 !important; box-shadow: none !important; }
            th, td { border: 1px solid #000 !important; padding: 4px; font-size: 9px !important; }
            .print-photo { width: 60px; height: 60px; object-fit: cover; border: 1px solid #000; }
        }
        .import-area { background: #fdfdfd; border: 2px dashed #cbd5e1; }
        .import-area:focus { border-color: #1e3a8a; background: #fff; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        function App() {
            // --- CORE STATE ---
            const [header, setHeader] = useState(() => {
                const saved = localStorage.getItem('keipl_h_v76');
                return saved ? JSON.parse(saved) : { 
                    customer: '', container: '', factory: '', destination: '', 
                    colour: '', marker: '', supervisor: '', defThick: '2', allowance: '0' 
                };
            });

            const [entries, setEntries] = useState(() => {
                const saved = localStorage.getItem('keipl_e_v76');
                return saved ? JSON.parse(saved) : [];
            });

            const [current, setCurrent] = useState({ bundle: '', gL:'', gW:'', nL:'', nW:'', photo: null });
            const [bulkText, setBulkText] = useState('');
            const [editingId, setEditingId] = useState(null);

            // --- PERSISTENCE ---
            useEffect(() => { localStorage.setItem('keipl_h_v76', JSON.stringify(header)); }, [header]);
            useEffect(() => { localStorage.setItem('keipl_e_v76', JSON.stringify(entries)); }, [entries]);

            // --- PHOTO HANDLER ---
            const handlePhoto = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setCurrent(p => ({ ...p, photo: reader.result }));
                    reader.readAsDataURL(file);
                }
            };

            // --- CALCULATION LOGIC ---
            const handleGrossInput = (field, val) => {
                const num = parseFloat(val) || 0;
                const ded = parseFloat(header.allowance) || 0;
                const net = num > ded ? num - ded : num;
                setCurrent(p => ({ ...p, [field]: val, [field==='gL'?'nL':'nW']: net.toString() }));
            };

            const addOrUpdate = () => {
                if (!current.gL || !current.gW) return;
                const gS = (parseFloat(current.gL)*parseFloat(current.gW))/10000;
                const nS = (parseFloat(current.nL)*parseFloat(current.nW))/10000;
                const kg = (gS * (parseFloat(header.defThick)/100) * 2850).toFixed(0);

                if (editingId) {
                    setEntries(entries.map(e => e.id === editingId ? { ...e, ...current, nSqm: nS.toFixed(3), wt: kg } : e));
                    setEditingId(null);
                } else {
                    const newSlab = {
                        ...current, id: Date.now(),
                        slabNo: `KEIPL/${(entries.length + 1).toString().padStart(2, '0')}`,
                        nSqm: nS.toFixed(3), wt: kg, thick: header.defThick
                    };
                    setEntries([newSlab, ...entries]);
                }
                setCurrent({ bundle: '', gL:'', gW:'', nL:'', nW:'', photo: null });
                if(document.getElementById('p-input')) document.getElementById('p-input').value = '';
            };

            // --- EXCEL EXPORT (FORMATTED) ---
            const downloadExcel = () => {
                let csv = `KUIPER EXPORTS & IMPORTS PVT LTD - PACKING LIST\n`;
                csv += `Customer,${header.customer},Container,${header.container}\n`;
                csv += `Factory,${header.factory},Destination,${header.destination}\n`;
                csv += `Colour,${header.colour},Thickness,${header.defThick} cm\n\n`;
                csv += `Slab No,Bundle,Gross Length,Gross Width,Net Length,Net Width,Net Area (SQM),Weight (KG)\n`;
                entries.forEach(e => {
                    csv += `${e.slabNo},${e.bundle || ''},${e.gL},${e.gW},${e.nL},${e.nW},${e.nSqm},${e.wt}\n`;
                });
                csv += `\nTOTALS,,, , , ,${totals.area} SQM,${totals.mt} MT\n`;
                csv += `Supervisor: ${header.supervisor}\n`;

                const blob = new Blob([csv], { type: 'text/csv' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = `PackingList_${header.container || 'Report'}.csv`; a.click();
            };

            const processBulkImport = () => {
                const rows = bulkText.trim().split('\n');
                const newEntries = rows.map((row, i) => {
                    const cols = row.includes('\t') ? row.split('\t') : row.split(',');
                    const gl = cols[0]?.trim(); const gw = cols[1]?.trim();
                    const nl = cols[2]?.trim() || gl; const nw = cols[3]?.trim() || gw;
                    const bundle = cols[4]?.trim() || '';
                    if (!gl || isNaN(gl)) return null;
                    const gS = (parseFloat(gl)*parseFloat(gw))/10000;
                    const nS = (parseFloat(nl)*parseFloat(nw))/10000;
                    return {
                        id: Date.now() + i, slabNo: `KEIPL/${(entries.length + i + 1).toString().padStart(2, '0')}`,
                        gL:gl, gW:gw, nL:nl, nW:nw, bundle: bundle, thick: header.defThick,
                        nSqm: nS.toFixed(3), wt: (gS * (header.defThick/100) * 2850).toFixed(0), photo: null
                    };
                }).filter(x => x);
                setEntries([...newEntries, ...entries]); setBulkText('');
            };

            const totals = useMemo(() => {
                const area = entries.reduce((a, b) => a + parseFloat(b.nSqm), 0);
                const weight = entries.reduce((a, b) => a + parseFloat(b.wt), 0);
                return { area: area.toFixed(3), mt: (weight/1000).toFixed(3) };
            }, [entries]);

            const clearAllData = () => {
                if(window.confirm("CRITICAL: This will delete ALL data. Are you sure?")) {
                    localStorage.clear();
                    setEntries([]);
                    setHeader({ customer: '', container: '', factory: '', destination: '', colour: '', marker: '', supervisor: '', defThick: '2', allowance: '0' });
                    window.location.reload();
                }
            }

            return (
                <div className="max-w-6xl mx-auto p-4 md:py-10">
                    {/* CORPORATE HEADER */}
                    <div className="bg-white p-8 border-t-[12px] border-blue-900 shadow-lg mb-6 report-box">
                        <div className="flex justify-between items-start mb-8 border-b-2 border-slate-100 pb-6">
                            <div>
                                <h1 className="text-5xl font-black text-blue-900 tracking-tighter leading-none">KUIPER</h1>
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-[0.4em] mt-2">Exports & Imports Pvt Ltd</p>
                            </div>
                            <div className="flex gap-3 no-print">
                                <button onClick={downloadExcel} className="bg-green-700 hover:bg-green-800 text-white px-5 py-2.5 rounded shadow text-xs font-black uppercase transition-all">Excel Export</button>
                                <button onClick={() => window.print()} className="bg-blue-900 hover:bg-slate-800 text-white px-5 py-2.5 rounded shadow text-xs font-black uppercase transition-all">PDF Report</button>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-6">
                            {['customer', 'container', 'factory', 'destination', 'colour', 'marker', 'supervisor', 'defThick'].map(k => (
                                <div key={k} className="border-b-2 border-slate-50">
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-1">{k === 'defThick' ? 'Thickness (cm)' : k}</label>
                                    <input className="w-full font-bold text-sm py-1 outline-none bg-transparent placeholder-slate-200" placeholder={`...`} value={header[k]} onChange={e => setHeader({...header, [k]: e.target.value})} />
                                </div>
                            ))}
                            <div className="border-b-2 border-slate-50">
                                <label className="block text-[10px] font-black text-blue-500 uppercase mb-1">Auto Allowance</label>
                                <select className="w-full font-bold text-sm py-1 outline-none bg-transparent" value={header.allowance} onChange={e => setHeader({...header, allowance: e.target.value})}>
                                    <option value="0">0 cm</option><option value="2">2 cm</option><option value="3">3 cm</option><option value="5">5 cm</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* BULK & MANUAL INPUTS */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 no-print mb-6">
                        <div className="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                             <h3 className="text-xs font-black uppercase text-slate-500 mb-4 flex items-center gap-2">
                                <span className="w-2 h-2 bg-blue-600 rounded-full"></span> Bulk Excel Paste (GL, GW, NL, NW, Bundle)
                             </h3>
                             <textarea className="w-full h-32 p-4 text-xs font-mono border import-area rounded outline-none mb-3" placeholder="Paste data here..." value={bulkText} onChange={e => setBulkText(e.target.value)}></textarea>
                             <button onClick={processBulkImport} className="bg-slate-800 text-white px-8 py-2.5 rounded text-xs font-black uppercase hover:bg-black transition-all">Import Now</button>
                        </div>

                        <div className="bg-slate-900 text-white p-6 rounded-xl shadow-xl flex flex-col justify-between">
                            <h3 className="text-xs font-black uppercase text-slate-400 mb-4 tracking-widest">Manual Entry</h3>
                            <div className="space-y-4">
                                <input type="text" placeholder="Bundle ID (Optional)" className="w-full p-2 rounded text-black font-bold outline-none text-xs" value={current.bundle} onChange={e => setCurrent({...current, bundle: e.target.value})} />
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="number" placeholder="Gross L" className="p-2 rounded text-black font-bold outline-none" value={current.gL} onChange={e => handleGrossInput('gL', e.target.value)} />
                                    <input type="number" placeholder="Gross W" className="p-2 rounded text-black font-bold outline-none" value={current.gW} onChange={e => handleGrossInput('gW', e.target.value)} />
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="number" placeholder="Net L" className="p-2 rounded bg-green-50 text-black font-bold outline-none" value={current.nL} onChange={e => setCurrent({...current, nL: e.target.value})} />
                                    <input type="number" placeholder="Net W" className="p-2 rounded bg-green-50 text-black font-bold outline-none" value={current.nW} onChange={e => setCurrent({...current, nW: e.target.value})} />
                                </div>
                                <div>
                                    <label className="text-[9px] font-bold text-slate-500 block mb-1">Add Photo</label>
                                    <input id="p-input" type="file" accept="image/*" onChange={handlePhoto} className="text-[10px] text-slate-400" />
                                </div>
                            </div>
                            <button onClick={addOrUpdate} className="mt-4 bg-blue-600 hover:bg-blue-500 py-3 rounded font-black uppercase text-xs shadow-lg transition-all">{editingId ? 'Update' : 'Add Slab'}</button>
                        </div>
                    </div>

                    {/* PACKING LIST TABLE */}
                    <div className="bg-white border border-slate-200 overflow-hidden shadow-sm report-box">
                        <table className="w-full text-center">
                            <thead className="bg-slate-50 border-b-2 border-slate-100">
                                <tr className="text-[10px] uppercase font-black text-slate-500 tracking-wider">
                                    <th className="p-4 text-left">Slab No</th>
                                    <th className="p-4">Bundle</th>
                                    <th className="p-4">Photo</th>
                                    <th className="p-4">Gross (cm)</th>
                                    <th className="p-4 text-green-700">Net (cm)</th>
                                    <th className="p-4 text-blue-900">Area (SQM)</th>
                                    <th className="p-4 no-print">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {entries.map(e => (
                                    <tr key={e.id} className="text-xs hover:bg-blue-50/20">
                                        <td className="p-4 text-left font-black text-blue-900 italic">{e.slabNo}</td>
                                        <td className="p-4 font-bold text-slate-600 uppercase">{e.bundle || '-'}</td>
                                        <td className="p-2">
                                            {e.photo ? <img src={e.photo} className="h-14 w-14 mx-auto object-cover rounded shadow-sm print-photo" /> : <span className="text-slate-300">-</span>}
                                        </td>
                                        <td className="p-4 text-slate-400">{e.gL} x {e.gW}</td>
                                        <td className="p-4 font-black text-green-700">{e.nL} x {e.nW}</td>
                                        <td className="p-4 font-black text-sm">{e.nSqm}</td>
                                        <td className="p-4 no-print">
                                            <button onClick={() => {setEditingId(e.id); setCurrent(e); window.scrollTo(0,0);}} className="text-blue-600 font-bold mr-4">EDIT</button>
                                            <button onClick={() => setEntries(entries.filter(x => x.id !== e.id))} className="text-red-300">✕</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* FOOTER SUMMARY */}
                    <div className="mt-8 flex flex-col md:flex-row justify-between items-end gap-6 border-t pt-8">
                        <div className="flex gap-4">
                            <div className="bg-blue-900 text-white px-8 py-4 rounded-lg shadow-xl">
                                <p className="text-[9px] font-black uppercase opacity-60 tracking-widest mb-1">Total Net Area</p>
                                <p className="text-3xl font-black">{totals.area} m²</p>
                            </div>
                            <div className="bg-green-700 text-white px-8 py-4 rounded-lg shadow-xl">
                                <p className="text-[9px] font-black uppercase opacity-60 tracking-widest mb-1">Est. Weight</p>
                                <p className="text-3xl font-black">{totals.mt} MT</p>
                            </div>
                        </div>
                        <div className="text-right min-w-[250px]">
                            <p className="text-[10px] font-black text-slate-400 uppercase mb-2">Checked By Supervisor</p>
                            <div className="border-t-2 border-slate-900 pt-2 font-black uppercase tracking-widest text-blue-900">
                                {header.supervisor || 'Signature'}
                            </div>
                        </div>
                    </div>

                    {/* RESET BUTTON */}
                    <div className="mt-16 text-center no-print">
                        <button onClick={clearAllData} className="bg-red-50 text-red-300 hover:bg-red-600 hover:text-white px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest transition-all">
                            Emergency Reset All Data
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
